# PDev-Live Install Wizard Enhancements

**Date:** 2026-01-08
**Purpose:** Add interactive configuration step to web-based installer
**Impact:** Partners can configure all 8 critical settings via web UI

---

## Overview

Enhanced the PDev Live web installer (`install-wizard.html`) to interactively collect all configuration variables before installation, eliminating the need for manual `.env` file creation.

---

## What Changed

### Before (3-Step Wizard)
1. **Mode Selection** - Source vs Project Server
2. **SSH Connection** - Server credentials
3. **Installation** - Terminal output

**Problem:** No way to configure partner-specific values (domain, IPs, passwords, etc.)

### After (4-Step Wizard)
1. **Mode Selection** - Source vs Project Server
2. **SSH Connection** - Server credentials
3. **Configuration** ‚≠ê NEW - Interactive form for all settings
4. **Installation** - Terminal output

---

## New Step 3: Configuration

### Form Sections

#### 1. Partner Identity
- **Domain Name*** - `config-partner-domain`
  - Validation: Valid domain format (`company.com`)
  - Used for: URLs, SSL certificates
  - Example: `acme-corp.com`

- **Company Name** - `config-partner-name`
  - Optional (defaults to domain)
  - Display name for organization

- **Server Name*** - `config-server-name`
  - Validation: Alphanumeric, hyphens, underscores only
  - Used for: Session tagging
  - Example: `prod-server-01`

#### 2. Server Inventory
- **Valid Servers*** - `config-valid-servers`
  - Comma-separated list
  - Example: `prod-01,prod-02,staging,dev`

- **Allowed IP Addresses*** - `config-allowed-ips`
  - Textarea (multi-line)
  - Comma-separated IPs
  - Validation: IPv4/IPv6 format
  - Example: `127.0.0.1,::1,10.0.1.5,10.0.1.6`

#### 3. Security Credentials
- **Database Password*** - `config-db-password`
  - Validation: Minimum 16 characters (32 recommended)
  - Auto-generation: "üé≤ Generate Secure Password" button

- **HTTP Basic Auth Username** - `config-auth-user`
  - Default: `pdev`

- **HTTP Basic Auth Password*** - `config-auth-password`
  - Validation: Minimum 12 characters (24 recommended)
  - Auto-generation: "üé≤ Generate Secure Password" button

- **Session Secret*** - `config-session-secret`
  - Validation: Minimum 16 characters (32 recommended)
  - Auto-generation: "üé≤ Generate Secure Secret" button

**Fields marked with * are required**

---

## Features Added

### 1. Password Generation
```javascript
function generatePassword(fieldId, length) {
    const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
    const array = new Uint8Array(length);
    crypto.getRandomValues(array);
    const password = Array.from(array).map(x => charset[x % charset.length]).join('');
    document.getElementById(fieldId).value = password;
    document.getElementById(fieldId).type = 'text'; // Show generated password
}
```

**Usage:**
- Click "üé≤ Generate Secure Password" button
- Uses `crypto.getRandomValues()` for cryptographically secure random generation
- Automatically shows generated password (changes type from `password` to `text`)

### 2. Client-Side Validation
```javascript
function validateConfigStep() {
    // Required field checks
    // Domain format validation: /^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,}$/i
    // Server name validation: /^[a-z0-9_-]+$/i
    // IP address validation: /^(\d{1,3}\.){3}\d{1,3}$|^::1$|^[0-9a-f:]+$/i
    // Password length checks (16/12/16 chars minimum)
}
```

**Validations:**
- Required fields present
- Domain format correct
- Server name alphanumeric
- Each IP address valid (IPv4/IPv6)
- Database password ‚â• 16 characters
- Auth password ‚â• 12 characters
- Session secret ‚â• 16 characters

### 3. .env File Generation
```javascript
function generateEnvFile(config) {
    return `# PDev-Live Configuration
# Generated by PDev Live Installer on ${new Date().toISOString()}

# Partner Identity
PARTNER_DOMAIN=${config.partnerDomain}
PARTNER_NAME="${config.partnerName}"
PARTNER_SERVER_NAME=${config.serverName}

# API Configuration
PDEV_LIVE_URL=https://${config.partnerDomain}/pdev/api
PDEV_BASE_URL=https://${config.partnerDomain}/pdev

# Server Inventory
VALID_SERVERS=${config.validServers}
ALLOWED_IPS=${config.allowedIps}

# Database Configuration
DB_PASSWORD=${config.dbPassword}

# Authentication
PDEV_AUTH_USER=${config.authUser}
PDEV_AUTH_PASSWORD=${config.authPassword}
SESSION_SECRET=${config.sessionSecret}

... (full .env with 42 variables)
`;
}
```

**Generated automatically:**
- All 42 environment variables
- Domain-based URL construction
- Timestamp header
- Organized sections with comments

### 4. Security
- **Immediate credential clearing:**
  ```javascript
  // SECURITY: Clear all sensitive fields immediately after reading
  document.getElementById('config-db-password').value = '';
  document.getElementById('config-auth-password').value = '';
  document.getElementById('config-session-secret').value = '';
  ```
- Credentials passed to WebSocket once, then cleared from DOM
- Password fields use `type="password"` (switch to `text` only after generation)

### 5. UI/UX Improvements
- **Visual sections:** Grouped by functionality (Identity, Inventory, Security)
- **Required field indicators:** Red asterisk `*`
- **Helpful placeholders:** Examples in every field
- **Small helper text:** Explains each field's purpose
- **Security tip box:** Encourages use of password generator

---

## User Flow

### Step-by-Step Experience

**Step 1: Mode Selection**
1. User sees two cards: "Source Server" vs "Project Server"
2. Clicks one ‚Üí Highlights selection
3. Click "Next ‚Üí"

**Step 2: SSH Connection**
4. Enter server host, port, username
5. Choose auth method (password or SSH key)
6. Enter domain (Source mode) or source URL (Project mode)
7. Click "Next ‚Üí"
8. Validation runs ‚Üí Proceeds if valid

**Step 3: Configuration** ‚≠ê NEW
9. Form appears with 3 sections
10. User fills in domain, server name, etc.
11. User clicks "üé≤ Generate Secure Password" for each credential field
12. Generated passwords appear in fields (visible)
13. User reviews/customizes if needed
14. Click "Start Installation ‚Üí"
15. Validation runs (domain format, IP format, password lengths)
16. If valid ‚Üí Proceeds to installation

**Step 4: Installation**
17. Terminal initializes
18. WebSocket connects to installer backend
19. `.env` file generated from Step 3 inputs
20. Installation proceeds with custom configuration

---

## Technical Implementation

### HTML Structure
```html
<div class="step" id="step-config">
  <h2>Configuration</h2>

  <div class="config-section">
    <h3>üè¢ Partner Identity</h3>
    <div class="form-group">
      <label for="config-partner-domain">Domain Name <span class="required">*</span></label>
      <input type="text" id="config-partner-domain" placeholder="e.g., acme-corp.com" required>
      <small>Your company's domain (used for URLs and SSL certificates)</small>
    </div>
    <!-- More fields... -->
  </div>

  <!-- More sections... -->
</div>
```

### JavaScript Navigation
```javascript
const stepElements = ['mode', 'ssh', 'config', 'install']; // Updated from 3 to 4 steps

// Step 2 ‚Üí Step 3
if (currentStep === 2) {
    if (validateSSHStep()) {
        goToStep(3); // Go to config step
    }
}

// Step 3 ‚Üí Step 4
else if (currentStep === 3) {
    if (validateConfigStep()) {
        startInstallation(); // Generates .env, goes to step 4
    }
}
```

### CSS Styling
```css
.config-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.required {
    color: #ff5252;
    font-weight: bold;
}

.btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    margin-top: 0.5rem;
}
```

---

## Integration with Backend

### WebSocket Payload
```javascript
connectWebSocket({
    // SSH connection (existing)
    host, port, username, authMethod, password, privateKey,

    // Mode/domain (existing)
    mode, domain, sourceUrl,

    // Configuration (NEW)
    envContent: generateEnvFile(config),
    config: {
        partnerDomain,
        partnerName,
        serverName,
        validServers,
        allowedIps,
        dbPassword,
        authUser,
        authPassword,
        sessionSecret
    }
});
```

**Backend receives:**
- `envContent` - Full `.env` file content
- `config` - Structured JSON object with all settings

**Backend uses:**
1. Create `/opt/services/pdev-live/.env` with `envContent`
2. Use `config` values during installation (PostgreSQL setup, nginx config, etc.)

---

## Validation Rules

| Field | Validation | Min Length | Format |
|-------|------------|------------|--------|
| Domain | Required | - | Regex: `^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,}$` |
| Server Name | Required | - | Regex: `^[a-z0-9_-]+$` |
| Valid Servers | Required | - | Comma-separated |
| Allowed IPs | Required | - | Valid IPv4/IPv6 (checked per IP) |
| DB Password | Required | 16 chars | Any (32 recommended) |
| Auth Password | Required | 12 chars | Any (24 recommended) |
| Session Secret | Required | 16 chars | Any (32 recommended) |

---

## Benefits

### For Partners
‚úÖ **No manual file creation** - All configuration via web UI
‚úÖ **Visual guidance** - Tooltips explain each field
‚úÖ **Error prevention** - Real-time validation
‚úÖ **Secure defaults** - One-click password generation
‚úÖ **Complete visibility** - See what values will be used

### For Maintainers
‚úÖ **Standardized deployments** - All installations use same format
‚úÖ **Reduced support burden** - Fewer configuration errors
‚úÖ **Audit trail** - `.env` timestamp shows when generated
‚úÖ **Easy updates** - Add new fields to wizard as needed

---

## Testing Checklist

### Manual Testing Required

- [ ] Step 1: Mode selection works (Source/Project)
- [ ] Step 2: SSH validation works (all fields required)
- [ ] Step 2‚Üí3: "Next" button advances to config step
- [ ] Step 3: All form fields render correctly
- [ ] Step 3: Password generator creates 32/24/32 char passwords
- [ ] Step 3: Generated passwords become visible (type="text")
- [ ] Step 3: Domain validation rejects invalid formats
- [ ] Step 3: Server name validation rejects special chars
- [ ] Step 3: IP validation rejects malformed IPs
- [ ] Step 3: Password length validation enforces minimums
- [ ] Step 3: Required field validation works
- [ ] Step 3‚Üí4: "Start Installation" button generates .env
- [ ] Step 4: Terminal initializes
- [ ] Step 4: WebSocket receives envContent and config
- [ ] Backend: `.env` file created on server
- [ ] Backend: Installation uses custom configuration
- [ ] Security: Sensitive fields cleared after submission
- [ ] UI: CSS styling looks good (sections, required markers)
- [ ] UX: Helper text visible and helpful

---

## Future Enhancements

### Potential Improvements
1. **Field-level validation feedback** - Show green checkmark as user types
2. **IP lookup** - Auto-detect current server IP
3. **Copy to clipboard** - For generated passwords
4. **Progress indicator** - Show "Step 3 of 4" at top
5. **Save draft** - LocalStorage to preserve partial input
6. **Advanced options** - Collapsible section for optional fields (backup retention, PM2 instances, etc.)
7. **Pre-flight checks** - Test domain reachability before installation
8. **Configuration preview** - Show generated `.env` before proceeding

---

## Known Limitations

1. **Backend integration pending** - WebSocket handler needs update to accept `envContent` and `config` parameters
2. **No field-level errors** - Validation shows single error message, not per-field highlights
3. **No password strength indicator** - Just minimum length check
4. **No IP range support** - Each IP must be listed explicitly (no CIDR notation)
5. **No configuration editing** - After installation, must SSH to edit `.env` manually

---

## Files Modified

**Single file change:**
- `frontend/install-wizard.html` (+400 lines)
  - Added Step 3 HTML structure
  - Added `generatePassword()` function
  - Added `validateSSHStep()` function
  - Added `validateConfigStep()` function
  - Added `generateEnvFile()` function
  - Updated `goToStep()` for 4 steps
  - Updated navigation logic for 4 steps
  - Added CSS for configuration sections

**No backend changes required** - Backend just needs to:
1. Accept `envContent` parameter
2. Write to `/opt/services/pdev-live/.env`
3. Use `config` values during installation

---

## Rollout Plan

### Phase 1: Frontend Only (Current)
- ‚úÖ Web wizard UI complete
- ‚úÖ Validation complete
- ‚úÖ .env generation complete
- ‚è≥ Backend integration needed

### Phase 2: Backend Integration (Next)
- Update WebSocket handler to accept `envContent`
- Write `.env` file to server before installation
- Use `config.partnerDomain` for nginx setup
- Test end-to-end on staging server

### Phase 3: Documentation Update
- Update `PARTNER_ONBOARDING_CHECKLIST.md` to reference wizard
- Add wizard screenshots to docs
- Update `README.md` with wizard URL
- Create video tutorial

### Phase 4: Production Rollout
- Deploy updated `install-wizard.html` to production
- Test with pilot partner
- Gather feedback
- Iterate

---

## Support

**Testing locally:**
```bash
# Serve frontend files
cd ~/projects/pdev-live/frontend
python3 -m http.server 8000

# Open browser
open http://localhost:8000/install-wizard.html
```

**Common issues:**
- "Terminal not loading" ‚Üí Check xterm.js CDN availability
- "Validation not working" ‚Üí Check browser console for JS errors
- "Generated password not showing" ‚Üí Ensure `generatePassword()` called correctly

---

**Document Owner:** PDev-Live Team
**Status:** Frontend Complete, Backend Integration Pending
**Last Updated:** 2026-01-08
**Version:** 1.0
