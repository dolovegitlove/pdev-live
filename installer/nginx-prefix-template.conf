# PDev-Live Nginx Prefix Configuration Fragment
# Generated by pdl-installer.sh with --url-prefix flag
#
# USAGE: Insert this location block inside your existing server {} block
# Example: Add to /etc/nginx/sites-enabled/yourdomain.com inside server { ... }
#
# VALIDATION: After installation, test with:
#   sudo nginx -t
#   sudo systemctl reload nginx
#   curl -I https://your-domain.com/URL_PREFIX/
#
# NOTE: URL_PREFIX placeholder will be replaced by installer (e.g., "pdev")
# Final result: location /pdev/ { ... }

    # PDev-Live at URL prefix
    # Authentication: Session-based (30-day cookie) - no nginx Basic Auth
    # Login required at /URL_PREFIX/live/login.html
    location /URL_PREFIX/ {
        # ====================================================================
        # SECURITY HEADERS
        # Note: Rate limiting is handled by Express.js middleware
        # ====================================================================
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

        # ====================================================================
        # PROXY TO EXPRESS.JS BACKEND
        # CRITICAL: Trailing slash strips /URL_PREFIX/ before proxying
        # Example: /pdev/live/ becomes /live/ at backend
        # ====================================================================
        proxy_pass http://127.0.0.1:3016/;
        proxy_http_version 1.1;

        # WebSocket and SSE support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;

        # Proxy headers for IP and protocol preservation
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for long-running operations (SSE, document generation)
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # ====================================================================
        # FILE UPLOAD SIZE LIMIT
        # ====================================================================
        client_max_body_size 50M;
    }
