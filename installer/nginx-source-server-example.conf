server {
    server_name walletsnack.com www.walletsnack.com;

    root /var/www/walletsnack.com;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    location /reels/ {
        allow all;
        expires 7d;
        add_header Cache-Control "public, max-age=604800" always;
    }

    location ~ /tiktok.*\.txt$ {
        charset utf-8;
        default_type text/plain;
    }

    location ~ /v/.*\.txt$ {
        charset utf-8;
        default_type text/plain;
    }

    location = /terms {
        rewrite ^/terms$ /terms.html last;
    }

    location = /privacy {
        rewrite ^/privacy$ /privacy.html last;
    }

    location = /setup {
        default_type text/markdown;
        add_header Content-Disposition "attachment; filename=GMAIL_FORWARDING_SETUP.md";
        try_files /setup.md =404;
    }

    location = /gidoc.md {
        add_header X-Robots-Tag "noindex, nofollow, noarchive, nosnippet" always;
        default_type application/octet-stream;
        add_header Content-Disposition "attachment; filename=gdrp-intrusion.md";
    }

    # Voice agent webhook endpoint
    location /aibook25 {
        proxy_pass http://localhost:3021;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Webhook timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ========================================================================
    # PDEV-LIVE API & DASHBOARD
    # ========================================================================

    # Health endpoint - no auth required (for installer verification)
    location = /pdev/health {
        proxy_pass http://127.0.0.1:3016/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Public registration endpoint - no auth required (installers use registration codes)
    location = /pdev/api/tokens/register-with-code {
        proxy_pass http://127.0.0.1:3016/tokens/register-with-code;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Admin registration code generation - HTTP Basic Auth required
    location = /pdev/api/admin/registration-code {
        auth_basic "PDev-Live Admin";
        auth_basic_user_file /etc/nginx/.htpasswd-pdev;

        proxy_pass http://127.0.0.1:3016/admin/registration-code;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # API with token auth (CLI clients) - no HTTP Basic Auth
    # Requires X-Pdev-Token header; backend validates token value
    location /pdev/api/ {
        # Reject requests without token header
        if ($http_x_pdev_token = "") {
            return 401 '{"error":"Missing X-Pdev-Token header"}';
        }
        add_header Content-Type application/json always;

        proxy_pass http://127.0.0.1:3016/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # Dashboard & legacy API (Browser clients) - HTTP Basic Auth
    location /pdev/ {
        # HTTP Basic Auth for PDev-Live
        auth_basic "PDev-Live Access";
        auth_basic_user_file /etc/nginx/.htpasswd-pdev;

        proxy_pass http://127.0.0.1:3016/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Timeouts for long-running operations
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    access_log /var/log/nginx/walletsnack.com.access.log;
    error_log /var/log/nginx/walletsnack.com.error.log;

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/walletsnack.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/walletsnack.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

server {
    if ($host = www.walletsnack.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    if ($host = walletsnack.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    listen [::]:80;
    server_name walletsnack.com www.walletsnack.com;
    return 404; # managed by Certbot




}
