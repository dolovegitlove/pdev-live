<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDev Live Installer</title>

    <!-- HTTPS Enforcement -->
    <script>
        // Enforce HTTPS in production (not localhost)
        if (window.location.protocol === 'http:' &&
            window.location.hostname !== 'localhost' &&
            window.location.hostname !== '127.0.0.1') {
            window.location.href = window.location.href.replace('http:', 'https:');
        }
    </script>

    <!-- Shared CSS -->
    <link rel="stylesheet" href="pdev-live.css">

    <!-- Page-specific CSS -->
    <link rel="stylesheet" href="install-wizard-specific.css">

    <!-- xterm.js for terminal -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
</head>
<body>
    <div class="wizard-container">
        <div class="wizard-header">
            <h1>‚ú® PDev Live Installer</h1>
            <p>Install PDev Live in minutes with our guided wizard</p>
        </div>

        <div class="wizard-body">
            <!-- Step 1: Mode Selection -->
            <div class="step active" id="step-mode">
                <h2>Choose Installation Mode</h2>
                <p class="step-description">Select how you want to install PDev Live</p>

                <div class="mode-selection">
                    <div class="mode-card" data-mode="source">
                        <div class="mode-icon">üè¢</div>
                        <h3>Source Server</h3>
                        <p>Full stack installation with database, nginx, and PM2. Host your own PDev Live backend.</p>
                    </div>

                    <div class="mode-card" data-mode="project">
                        <div class="mode-icon">üì¶</div>
                        <h3>Project Server</h3>
                        <p>Client-only installation. Connect to an existing PDev Live source server.</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: SSH Connection -->
            <div class="step" id="step-ssh">
                <h2>Server Connection</h2>
                <p class="step-description">Enter your server credentials to begin installation</p>

                <div class="form-group">
                    <label for="ssh-host">Server Host</label>
                    <input type="text" id="ssh-host" placeholder="e.g., pdev.example.com or 192.168.1.100" required>
                    <small>IP address or domain name of your server</small>
                </div>

                <div class="form-group">
                    <label for="ssh-port">SSH Port</label>
                    <input type="number" id="ssh-port" value="22" required>
                </div>

                <div class="form-group">
                    <label for="ssh-username">Username</label>
                    <input type="text" id="ssh-username" placeholder="e.g., root or ubuntu" required>
                    <div class="status-message status-info sudo-warning">
                        <strong>‚ö†Ô∏è Sudo Privileges Required</strong><br>
                        The SSH user must have passwordless sudo privileges. Installation requires system-level package installation (PostgreSQL, nginx, Node.js, PM2).<br>
                        <small>Example: ubuntu, root, or custom user with NOPASSWD in /etc/sudoers</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="auth-method">Authentication Method</label>
                    <select id="auth-method">
                        <option value="password">Password</option>
                        <option value="key">SSH Private Key</option>
                    </select>
                </div>

                <div class="form-group" id="password-field">
                    <label for="ssh-password">Password</label>
                    <input type="password" id="ssh-password" placeholder="Your SSH password" autocomplete="off" autocapitalize="off" required>
                </div>

                <div class="form-group hidden" id="key-field">
                    <label for="ssh-key">Private Key</label>
                    <textarea id="ssh-key" rows="6"></textarea>
                    <small>Paste your private key (e.g., contents of ~/.ssh/id_rsa)</small>
                </div>

                <div class="form-group hidden" id="domain-field">
                    <label for="install-domain">Domain Name</label>
                    <input type="text" id="install-domain" placeholder="e.g., pdev.example.com">
                    <small>Required for Source Server installation</small>
                </div>

                <div class="form-group hidden" id="source-url-field">
                    <label for="install-source-url">Source Server URL</label>
                    <input type="text" id="install-source-url" placeholder="e.g., https://pdev.example.com/pdev/api">
                    <small>Required for Project Server installation</small>
                </div>
            </div>

            <!-- Step 3: Installation -->
            <div class="step" id="step-install">
                <div id="status-messages"></div>
                <div id="terminal-container"></div>
            </div>

            <!-- Wizard Footer -->
            <div class="wizard-footer">
                <button class="btn btn-secondary hidden" id="btn-back">‚Üê Back</button>
                <div class="flex-spacer"></div>
                <button class="btn btn-primary" id="btn-next">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- xterm.js -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <script>
        let currentStep = 1;
        let selectedMode = null;
        let terminal = null;
        let ws = null;

        // Mode selection
        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedMode = this.dataset.mode;

                // Show/hide relevant fields
                const domainField = document.getElementById('domain-field');
                const sourceUrlField = document.getElementById('source-url-field');

                if (selectedMode === 'source') {
                    domainField.classList.remove('hidden');
                    sourceUrlField.classList.add('hidden');
                } else {
                    domainField.classList.add('hidden');
                    sourceUrlField.classList.remove('hidden');
                }
            });
        });

        // Auth method toggle
        document.getElementById('auth-method').addEventListener('change', function() {
            const passwordField = document.getElementById('password-field');
            const keyField = document.getElementById('key-field');

            if (this.value === 'password') {
                passwordField.classList.remove('hidden');
                keyField.classList.add('hidden');
            } else {
                passwordField.classList.add('hidden');
                keyField.classList.remove('hidden');
            }
        });

        // Navigation
        document.getElementById('btn-next').addEventListener('click', function() {
            if (currentStep === 1) {
                if (!selectedMode) {
                    showStatus('error', 'Please select an installation mode');
                    return;
                }
                goToStep(2);
            } else if (currentStep === 2) {
                startInstallation();
            }
        });

        document.getElementById('btn-back').addEventListener('click', function() {
            goToStep(currentStep - 1);
        });

        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            const stepElements = ['mode', 'ssh', 'install'];
            document.getElementById(`step-${stepElements[step - 1]}`).classList.add('active');

            currentStep = step;

            const backBtn = document.getElementById('btn-back');
            const nextBtn = document.getElementById('btn-next');
            const footer = document.querySelector('.wizard-footer');

            if (step > 1 && step < 3) {
                backBtn.classList.remove('hidden');
            } else {
                backBtn.classList.add('hidden');
            }

            if (step < 3) {
                nextBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.add('hidden');
            }

            if (step === 3) {
                footer.classList.add('hidden');
            } else {
                footer.classList.remove('hidden');
            }
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('status-messages');
            const statusEl = document.createElement('div');
            statusEl.className = `status-message status-${type}`;
            statusEl.textContent = message;
            statusDiv.appendChild(statusEl);

            if (type !== 'error') {
                setTimeout(() => statusEl.remove(), 5000);
            }
        }

        function startInstallation() {
            const host = document.getElementById('ssh-host').value;
            const port = document.getElementById('ssh-port').value;
            const username = document.getElementById('ssh-username').value;
            const authMethod = document.getElementById('auth-method').value;
            const password = authMethod === 'password' ? document.getElementById('ssh-password').value : '';
            const privateKey = authMethod === 'key' ? document.getElementById('ssh-key').value : '';

            if (!host || !username || (authMethod === 'password' && !password) || (authMethod === 'key' && !privateKey)) {
                showStatus('error', 'Please fill in all required fields');
                return;
            }

            // SECURITY: Clear credential fields immediately after reading
            document.getElementById('ssh-password').value = '';
            document.getElementById('ssh-key').value = '';

            goToStep(3);

            // Initialize terminal
            initTerminal();

            // Connect WebSocket
            connectWebSocket({
                host,
                port: parseInt(port),
                username,
                authMethod,
                password,
                privateKey,
                mode: selectedMode,
                domain: selectedMode === 'source' ? document.getElementById('install-domain').value : '',
                sourceUrl: selectedMode === 'project' ? document.getElementById('install-source-url').value : ''
            });
        }

        function initTerminal() {
            // DEFENSIVE CHECK: Verify container exists
            const container = document.getElementById('terminal-container');
            if (!container) {
                console.error('[FATAL] Terminal container element not found');
                showStatus('error', 'Terminal initialization failed: container not found');
                return false;
            }

            // DEFENSIVE CHECK: Verify xterm.js loaded
            if (typeof Terminal === 'undefined' || typeof FitAddon === 'undefined') {
                console.error('[FATAL] xterm.js libraries failed to load');
                showStatus('error', 'Terminal initialization failed: libraries not loaded. Check your internet connection.');
                return false;
            }

            // PREVENT DOUBLE INITIALIZATION
            if (terminal) {
                console.warn('[WARN] Terminal already initialized, cleaning up old instance');
                cleanupTerminal();
            }

            try {
                container.classList.add('active');

                terminal = new Terminal({
                    cursorBlink: true,
                    fontSize: 14,
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    theme: {
                        background: '#1e1e1e',
                        foreground: '#d4d4d4'
                    }
                });

                const fitAddon = new FitAddon.FitAddon();
                terminal.loadAddon(fitAddon);
                terminal.open(container);

                // Force reflow before fit()
                container.offsetHeight;  // Trigger synchronous layout calculation

                // Use requestAnimationFrame for guaranteed paint
                requestAnimationFrame(() => {
                    try {
                        fitAddon.fit();
                    } catch (err) {
                        console.error('[ERROR] Terminal fit failed:', err);
                    }
                });

                // MEMORY LEAK PREVENTION: Store resize handler for cleanup
                const resizeHandler = () => {
                    requestAnimationFrame(() => {
                        try {
                            fitAddon.fit();
                        } catch (err) {
                            console.error('[ERROR] Terminal resize fit failed:', err);
                        }
                    });
                };

                window.addEventListener('resize', resizeHandler);

                // Store handler for cleanup (attach to terminal object)
                terminal._resizeHandler = resizeHandler;

                return true;

            } catch (err) {
                console.error('[FATAL] Terminal initialization failed:', err);
                showStatus('error', 'Terminal initialization failed: ' + err.message);
                terminal = null;  // Ensure terminal is null on failure
                return false;
            }
        }

        // CLEANUP FUNCTION
        function cleanupTerminal() {
            if (!terminal) return;

            try {
                // Remove resize listener
                if (terminal._resizeHandler) {
                    window.removeEventListener('resize', terminal._resizeHandler);
                }

                // Dispose terminal instance
                terminal.dispose();
                terminal = null;

            } catch (err) {
                console.error('[ERROR] Terminal cleanup failed:', err);
            }
        }

        async function connectWebSocket(config) {
            showStatus('info', 'Requesting installation token...');

            try {
                // Request token from server
                const tokenRes = await fetch('/pdev/installer/token', { method: 'POST' });
                if (!tokenRes.ok) {
                    throw new Error('Failed to obtain installation token');
                }
                const { token } = await tokenRes.json();

                showStatus('info', 'Connecting to server...');

                // SECURITY: Enforce wss:// in production (not localhost)
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                if (window.location.hostname !== 'localhost' &&
                    window.location.hostname !== '127.0.0.1' &&
                    protocol === 'ws:') {
                    showStatus('error', 'Secure connection required. Please use HTTPS.');
                    return;
                }

                const wsUrl = `${protocol}//${window.location.host}/pdev/webssh?token=${token}`;

                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    showStatus('success', 'Connected! Starting installation...');
                    ws.send(JSON.stringify({ type: 'auth', ...config }));
                };
            } catch (err) {
                showStatus('error', 'Connection failed: ' + err.message);
                return;
            }

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'output') {
                    if (terminal) {
                        terminal.write(data.data);
                    } else {
                        console.error('[ERROR] Terminal not initialized, cannot write output');
                    }
                } else if (data.type === 'error') {
                    showStatus('error', data.message);
                    if (terminal) {
                        terminal.write(`\r\n\x1b[31mError: ${data.message}\x1b[0m\r\n`);
                    }
                } else if (data.type === 'success') {
                    showStatus('success', 'Installation completed successfully!');
                    if (terminal) {
                        terminal.write(`\r\n\x1b[32m‚úÖ Installation complete!\x1b[0m\r\n`);
                    }
                }
            };

            ws.onerror = (error) => {
                showStatus('error', 'WebSocket connection failed. Please check your network and try again.');
                if (terminal) {
                    terminal.write('\r\n\x1b[31mWebSocket connection error\x1b[0m\r\n');
                }
            };

            ws.onclose = () => {
                if (terminal) {
                    terminal.write('\r\n\x1b[33mConnection closed\x1b[0m\r\n');
                }
                cleanupTerminal();
            };
        }
    </script>
</body>
</html>
