<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDev Live Installer</title>

    <!-- HTTPS Enforcement -->
    <script>
        // Enforce HTTPS in production (not localhost)
        if (window.location.protocol === 'http:' &&
            window.location.hostname !== 'localhost' &&
            window.location.hostname !== '127.0.0.1') {
            window.location.href = window.location.href.replace('http:', 'https:');
        }
    </script>

    <!-- Shared CSS -->
    <link rel="stylesheet" href="pdev-live.css">

    <!-- Page-specific CSS -->
    <link rel="stylesheet" href="install-wizard-specific.css">

    <!-- xterm.js for terminal -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">

    <style>
        .config-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .config-section h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #00bfa5;
            font-size: 1.1rem;
        }

        .required {
            color: #ff5252;
            font-weight: bold;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #00bfa5;
            box-shadow: 0 0 0 2px rgba(0, 191, 165, 0.2);
        }

        .pre-setup-instructions {
            background: rgba(255, 243, 205, 0.95);
            border: 2px solid #ffa726;
            border-radius: 8px;
            padding: 20px;
            margin: 1.5rem;
            margin-bottom: 30px;
        }

        .pre-setup-instructions h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #b45309; /* WCAG AA: 6.2:1 contrast on warm background */
            font-size: 1.2rem;
        }

        .pre-setup-instructions p {
            color: #2d3748; /* WCAG AA: 11.2:1 contrast (was #e0e0e0 at 1.8:1) */
            line-height: 1.6;
        }

        .pre-setup-instructions pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', Monaco, monospace;
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pre-setup-instructions pre code {
            font-family: inherit;
            font-size: inherit;
        }

        .pre-setup-instructions .highlight {
            color: #047857; /* WCAG AA: 7.1:1 contrast (was #00bfa5 at 2.5:1) */
            font-weight: 600;
        }

        /* Accessibility: Respect motion preferences */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* Touch target improvements */
        .btn-sm {
            min-width: 44px;
            min-height: 44px;
            padding: 0.6rem 1rem; /* Increased from 0.4rem 0.8rem */
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <div class="wizard-header">
            <h1>‚ú® PDev Live Installer</h1>
            <p>Install PDev Live in minutes with our guided wizard</p>
        </div>

        <!-- Pre-Setup Instructions -->
        <div class="pre-setup-instructions">
            <h3>‚ö†Ô∏è Before You Begin - Generate Your Installation Values</h3>
            <p><strong>Copy this prompt into Claude Code:</strong></p>
            <pre><code>I need to install PDev-Live. Ask me these questions ONE AT A TIME and wait for my answer before asking the next:

1. Is this a Source Server or Project Server?
   - Source Server: Full installation with database, nginx, PM2 (hosts the PDev Live backend)
   - Project Server: Client-only installation (connects to existing Source Server)

**[ONLY ASK IF SOURCE SERVER - Skip for Project Server]**
2. What domain will PDev-Live run on? (e.g., walletsnack.com)
3. What server names should be allowed to connect? (comma-separated, e.g., ittz,acme,cfree,wsrv)
4. What IP addresses should be whitelisted for API access? (comma-separated, include all project server IPs)

**[ONLY ASK IF PROJECT SERVER - Skip for Source Server]**
5. What URL hosts your install wizard and files? (e.g., https://pdev.example.com/pdev)

**[ASK FOR ALL INSTALLATIONS]**
6. What is the IP address of this server?
7. Do you have SSH access to this server configured in your ~/.ssh/config?
   - If YES: I'll use your existing SSH config to connect
   - If NO: What SSH username should I use? (e.g., root, ubuntu)

After I've answered all questions, you MUST:

**STEP 2: Create the pdev service user** (run these exact commands):
```bash
# Create user with home directory and bash shell
sudo useradd -m -s /bin/bash pdev

# Generate and set secure random password
PASSWORD=$(openssl rand -base64 24 | tr -dc 'A-Za-z0-9' | head -c 24)
echo "pdev:$PASSWORD" | sudo chpasswd

# Grant passwordless sudo for installation
echo "pdev ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/pdev
sudo chmod 440 /etc/sudoers.d/pdev

# Create SSH directory structure
sudo mkdir -p /home/pdev/.ssh
sudo chmod 700 /home/pdev/.ssh

# Generate ED25519 keypair for pdev user
sudo ssh-keygen -t ed25519 -f /home/pdev/.ssh/id_ed25519 -N "" -C "pdev-live-service"

# Add public key to authorized_keys
sudo cat /home/pdev/.ssh/id_ed25519.pub | sudo tee /home/pdev/.ssh/authorized_keys
sudo chmod 600 /home/pdev/.ssh/authorized_keys
sudo chown -R pdev:pdev /home/pdev/.ssh

# Verify user was created
id pdev
```

**STEP 3: Test SSH as pdev user**
SSH to [server-ip] as pdev using the generated password to verify it works.

**STEP 4: Output credentials** in EXACTLY this format:

**Installation Mode:** [Source Server / Project Server]

**PAGE 1 - Server Connection**
Server Host: [ip-address]
SSH Port: 22
Username: pdev
Authentication Method: Password
Password: [the $PASSWORD you generated above]
Domain Name: [domain - Source Server only]
Install Files URL: [https://your-pdev-host.com/pdev - Project Server only]

**PAGE 2 - Configuration** [Source Server only - skip for Project Server]
Domain Name: [domain]
Valid Servers: [comma-separated server names]
Allowed IP Addresses: [comma-separated IPs including 127.0.0.1,::1]
Database Password: [generate 32-char random alphanumeric]
HTTP Basic Auth Username: pdev
HTTP Basic Auth Password: [generate 24-char random alphanumeric]
Session Secret: [generate 32-char random alphanumeric]

**NOTE for Project Server:** HTTP auth credentials are automatically provided during installation. No manual configuration needed - just enter SSH credentials and the URL where installer files are hosted.

**SSH Private Key (SAVE THIS for future access as pdev):**
[show contents of /home/pdev/.ssh/id_ed25519]
</code></pre>
            <p><strong>After Claude generates the values:</strong> Copy them into the form fields below.</p>
        </div>

        <div class="wizard-body">
            <!-- Step 1: Mode Selection -->
            <div class="step active" id="step-mode">
                <h2>Choose Installation Mode</h2>
                <p class="step-description">Select how you want to install PDev Live</p>

                <div class="mode-selection">
                    <div class="mode-card" data-mode="source">
                        <div class="mode-icon">üè¢</div>
                        <h3>Source Server</h3>
                        <p>Full stack installation with database, nginx, and PM2. Host your own PDev Live backend.</p>
                    </div>

                    <div class="mode-card" data-mode="project">
                        <div class="mode-icon">üì¶</div>
                        <h3>Project Server</h3>
                        <p>Client-only installation. Connect to an existing PDev Live source server.</p>
                    </div>
                </div>
            </div>

            <!-- Step 2: SSH Connection -->
            <div class="step" id="step-ssh">
                <h2>Server Connection</h2>
                <p class="step-description">Enter your server credentials to begin installation</p>

                <div class="form-group">
                    <label for="ssh-host">Server Host</label>
                    <input type="text" id="ssh-host" placeholder="e.g., pdev.example.com or 192.168.1.100" required>
                    <small>IP address or domain name of your server</small>
                </div>

                <div class="form-group">
                    <label for="ssh-port">SSH Port</label>
                    <input type="number" id="ssh-port" value="22" required>
                </div>

                <div class="form-group">
                    <label for="ssh-username">Username</label>
                    <input type="text" id="ssh-username" placeholder="e.g., root or ubuntu" required>
                    <div class="status-message status-info sudo-warning">
                        <strong>‚ö†Ô∏è Sudo Privileges Required</strong><br>
                        The SSH user must have passwordless sudo privileges. Installation requires system-level package installation (PostgreSQL, nginx, Node.js, PM2).<br>
                        <small>Example: ubuntu, root, or custom user with NOPASSWD in /etc/sudoers</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="auth-method">Authentication Method</label>
                    <select id="auth-method">
                        <option value="password">Password</option>
                        <option value="privateKey">SSH Private Key</option>
                    </select>
                </div>

                <div class="form-group" id="password-field">
                    <label for="ssh-password">Password</label>
                    <input type="password" id="ssh-password" placeholder="Your SSH password" autocomplete="off" autocapitalize="off" required>
                </div>

                <div class="form-group hidden" id="key-field">
                    <label for="ssh-key">Private Key</label>
                    <textarea id="ssh-key" rows="10" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAA...
...your key content here...
-----END OPENSSH PRIVATE KEY-----

Or RSA PEM format:
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA...
-----END RSA PRIVATE KEY-----"></textarea>
                    <small>Paste your private key (OpenSSH or RSA PEM format). Find it at <code>~/.ssh/id_rsa</code> or <code>~/.ssh/id_ed25519</code></small>
                </div>

                <div class="form-group hidden" id="domain-field">
                    <label for="install-domain">Domain Name</label>
                    <input type="text" id="install-domain" placeholder="e.g., pdev.example.com">
                    <small>Required for Source Server installation</small>
                </div>

                <div class="form-group hidden" id="source-url-field">
                    <label for="install-source-url">Install Files URL</label>
                    <input type="text" id="install-source-url" placeholder="e.g., https://pdev.example.com/pdev">
                    <small>URL where the install wizard and installer files are hosted.</small>
                </div>

            </div>

            <!-- Step 3: Configuration -->
            <div class="step" id="step-config">
                <h2>Configuration</h2>
                <p class="step-description">Configure PDev Live for your infrastructure</p>

                <div class="config-section">
                    <h3>üè¢ Partner Identity</h3>

                    <div class="form-group">
                        <label for="config-partner-domain">Domain Name <span class="required">*</span></label>
                        <input type="text" id="config-partner-domain" placeholder="e.g., acme-corp.com" required>
                        <small>Your company's domain (used for URLs and SSL certificates)</small>
                    </div>

                </div>

                <div class="config-section">
                    <h3>üñ•Ô∏è Server Inventory</h3>

                    <div class="form-group">
                        <label for="config-valid-servers">Valid Servers <span class="required">*</span></label>
                        <input type="text" id="config-valid-servers" placeholder="e.g., prod-01,prod-02,staging,dev" required>
                        <small>Comma-separated list of server names in your infrastructure</small>
                    </div>

                    <div class="form-group">
                        <label for="config-allowed-ips">Allowed IP Addresses <span class="required">*</span></label>
                        <textarea id="config-allowed-ips" rows="3" placeholder="127.0.0.1,::1,10.0.1.5,10.0.1.6" required></textarea>
                        <small>Comma-separated IP addresses for API whitelist (include all servers that will POST to PDev Live)</small>
                    </div>
                </div>

                <div class="config-section">
                    <h3>üîí Security Credentials</h3>

                    <div class="form-group">
                        <label for="config-db-password">Database Password <span class="required">*</span></label>
                        <input type="password" id="config-db-password" placeholder="Enter database password provided by Claude" required>
                        <small>PostgreSQL password (provided by Claude during setup)</small>
                    </div>

                    <div class="form-group">
                        <label for="config-auth-user">HTTP Basic Auth Username</label>
                        <input type="text" id="config-auth-user" value="pdev">
                        <small>Username for web interface access</small>
                    </div>

                    <div class="form-group">
                        <label for="config-auth-password">HTTP Basic Auth Password <span class="required">*</span></label>
                        <input type="password" id="config-auth-password" placeholder="Enter HTTP auth password provided by Claude" required>
                        <small>Password for web interface access (provided by Claude during setup)</small>
                    </div>

                    <div class="form-group">
                        <label for="config-session-secret">Session Secret <span class="required">*</span></label>
                        <input type="password" id="config-session-secret" placeholder="Enter session secret provided by Claude" required>
                        <small>Express session encryption key (provided by Claude during setup)</small>
                    </div>
                </div>

                <div class="status-message status-info">
                    <strong>üí° Security Tip:</strong> Claude will generate cryptographically random credentials during setup and provide them to you. Copy them into the fields above.
                </div>
            </div>

            <!-- Step 4: Installation -->
            <div class="step" id="step-install">
                <div id="status-messages"></div>
                <div id="terminal-container"></div>
            </div>

            <!-- Wizard Footer -->
            <div class="wizard-footer">
                <button class="btn btn-secondary hidden" id="btn-back">‚Üê Back</button>
                <div class="flex-spacer"></div>
                <button class="btn btn-primary" id="btn-next">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- xterm.js -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <script>
        let currentStep = 1;
        let selectedMode = null;
        let terminal = null;
        let ws = null;

        // Mode selection
        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedMode = this.dataset.mode;

                // Show/hide relevant fields
                const domainField = document.getElementById('domain-field');
                const sourceUrlField = document.getElementById('source-url-field');

                if (selectedMode === 'source') {
                    domainField.classList.remove('hidden');
                    sourceUrlField.classList.add('hidden');
                } else {
                    domainField.classList.add('hidden');
                    sourceUrlField.classList.remove('hidden');
                }
            });
        });

        // Auth method toggle
        document.getElementById('auth-method').addEventListener('change', function() {
            const passwordField = document.getElementById('password-field');
            const keyField = document.getElementById('key-field');

            if (this.value === 'password') {
                passwordField.classList.remove('hidden');
                keyField.classList.add('hidden');
            } else {
                passwordField.classList.add('hidden');
                keyField.classList.remove('hidden');
            }
        });

        // Navigation
        document.getElementById('btn-next').addEventListener('click', function() {
            if (currentStep === 1) {
                if (!selectedMode) {
                    showStatus('error', 'Please select an installation mode');
                    return;
                }
                goToStep(2);
            } else if (currentStep === 2) {
                if (validateSSHStep()) {
                    // Project Server skips config step (Step 3) - go directly to install
                    if (selectedMode === 'project') {
                        startInstallation();
                    } else {
                        goToStep(3);
                    }
                }
            } else if (currentStep === 3) {
                if (validateConfigStep()) {
                    startInstallation();
                }
            }
        });

        document.getElementById('btn-back').addEventListener('click', function() {
            goToStep(currentStep - 1);
        });

        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            const stepElements = ['mode', 'ssh', 'config', 'install'];
            document.getElementById(`step-${stepElements[step - 1]}`).classList.add('active');

            currentStep = step;

            // Hide pre-setup instructions once user moves past mode selection
            const preSetupInstructions = document.querySelector('.pre-setup-instructions');
            if (step > 1 && preSetupInstructions) {
                preSetupInstructions.style.display = 'none';
            } else if (step === 1 && preSetupInstructions) {
                preSetupInstructions.style.display = 'block';
            }

            const backBtn = document.getElementById('btn-back');
            const nextBtn = document.getElementById('btn-next');
            const footer = document.querySelector('.wizard-footer');

            // Show back button on all steps except first and last
            if (step > 1 && step < 4) {
                backBtn.classList.remove('hidden');
            } else {
                backBtn.classList.add('hidden');
            }

            // Show next button on all steps except last
            if (step < 4) {
                nextBtn.classList.remove('hidden');
                // Change button text on config step (Step 3) or SSH step for Project Server
                if (step === 3) {
                    nextBtn.textContent = 'Start Installation ‚Üí';
                } else if (step === 2 && selectedMode === 'project') {
                    nextBtn.textContent = 'Start Installation ‚Üí';
                } else {
                    nextBtn.textContent = 'Next ‚Üí';
                }
            } else {
                nextBtn.classList.add('hidden');
            }

            // Hide footer on installation step
            if (step === 4) {
                footer.classList.add('hidden');
            } else {
                footer.classList.remove('hidden');
            }
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('status-messages');
            const statusEl = document.createElement('div');
            statusEl.className = `status-message status-${type}`;
            statusEl.textContent = message;
            statusDiv.appendChild(statusEl);

            if (type !== 'error') {
                setTimeout(() => statusEl.remove(), 5000);
            }
        }

        // Password generation
        function generatePassword(fieldId, length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            const password = Array.from(array).map(x => charset[x % charset.length]).join('');
            document.getElementById(fieldId).value = password;
            document.getElementById(fieldId).type = 'text'; // Show generated password
        }

        // SSH step validation
        function validateSSHStep() {
            const host = document.getElementById('ssh-host').value;
            const username = document.getElementById('ssh-username').value;
            const authMethod = document.getElementById('auth-method').value;
            const password = authMethod === 'password' ? document.getElementById('ssh-password').value : '';
            const privateKey = authMethod === 'privateKey' ? document.getElementById('ssh-key').value : '';
            const domain = selectedMode === 'source' ? document.getElementById('install-domain').value : '';
            const sourceUrl = selectedMode === 'project' ? document.getElementById('install-source-url').value : '';

            if (!host || !username) {
                showStatus('error', 'Please enter server host and username');
                return false;
            }

            if (authMethod === 'password' && !password) {
                showStatus('error', 'Please enter SSH password');
                return false;
            }

            // SSH key is optional - user may have pre-configured keys on server

            if (selectedMode === 'source' && !domain) {
                showStatus('error', 'Please enter domain name for Source Server installation');
                return false;
            }

            if (selectedMode === 'project' && !sourceUrl) {
                showStatus('error', 'Please enter source server URL for Project Server installation');
                return false;
            }

            return true;
        }

        // Configuration step validation
        function validateConfigStep() {
            const partnerDomain = document.getElementById('config-partner-domain').value;
            const validServers = document.getElementById('config-valid-servers').value;
            const allowedIps = document.getElementById('config-allowed-ips').value;
            const dbPassword = document.getElementById('config-db-password').value;
            const authPassword = document.getElementById('config-auth-password').value;
            const sessionSecret = document.getElementById('config-session-secret').value;

            // Check required fields
            if (!partnerDomain || !validServers || !allowedIps || !dbPassword || !authPassword || !sessionSecret) {
                showStatus('error', 'Please fill in all required fields (marked with *)');
                return false;
            }

            // Validate domain format
            if (!/^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,}$/i.test(partnerDomain)) {
                showStatus('error', 'Invalid domain format. Example: company.com');
                return false;
            }

            // Validate IP addresses
            const ips = allowedIps.split(',').map(ip => ip.trim());
            const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$|^::1$|^[0-9a-f:]+$/i;
            for (const ip of ips) {
                if (ip && !ipRegex.test(ip)) {
                    showStatus('error', `Invalid IP address: ${ip}`);
                    return false;
                }
            }

            // Validate password lengths
            if (dbPassword.length < 16) {
                showStatus('error', 'Database password must be at least 16 characters (32 recommended)');
                return false;
            }

            if (authPassword.length < 12) {
                showStatus('error', 'HTTP Basic Auth password must be at least 12 characters (24 recommended)');
                return false;
            }

            if (sessionSecret.length < 16) {
                showStatus('error', 'Session secret must be at least 16 characters (32 recommended)');
                return false;
            }

            return true;
        }

        function startInstallation() {
            const host = document.getElementById('ssh-host').value;
            const port = document.getElementById('ssh-port').value;
            const username = document.getElementById('ssh-username').value;
            const authMethod = document.getElementById('auth-method').value;
            const password = authMethod === 'password' ? document.getElementById('ssh-password').value : '';
            const privateKey = authMethod === 'privateKey' ? document.getElementById('ssh-key').value : '';

            // Collect configuration based on mode
            let config = {};
            if (selectedMode === 'source') {
                config = {
                    partnerDomain: document.getElementById('config-partner-domain').value,
                    validServers: document.getElementById('config-valid-servers').value,
                    allowedIps: document.getElementById('config-allowed-ips').value,
                    dbPassword: document.getElementById('config-db-password').value,
                    authUser: document.getElementById('config-auth-user').value,
                    authPassword: document.getElementById('config-auth-password').value,
                    sessionSecret: document.getElementById('config-session-secret').value
                };
            } else if (selectedMode === 'project') {
                // Project mode credentials come from source server's token response
                // Will be populated in connectWebSocket after token fetch
                config = { pendingSourceAuth: true };
            }

            // Generate .env file content (source mode only)
            const envContent = selectedMode === 'source' ? generateEnvFile(config) : '';

            // SECURITY: Clear all sensitive fields immediately after reading
            document.getElementById('ssh-password').value = '';
            document.getElementById('ssh-key').value = '';
            document.getElementById('config-db-password').value = '';
            document.getElementById('config-auth-password').value = '';
            document.getElementById('config-session-secret').value = '';

            goToStep(4);

            // Initialize terminal
            initTerminal();

            // Connect WebSocket
            connectWebSocket({
                host,
                port: parseInt(port),
                username,
                authMethod,
                password,
                privateKey,
                mode: selectedMode,
                domain: selectedMode === 'source' ? document.getElementById('install-domain').value : '',
                sourceUrl: selectedMode === 'project' ? document.getElementById('install-source-url').value : '',
                envContent: envContent,
                config: config
            });
        }

        function generateEnvFile(config) {
            // NOTE: PARTNER_NAME and PARTNER_SERVER_NAME are auto-detected by installer
            // - PARTNER_NAME: Derived from domain (e.g., walletsnack.com -> Walletsnack)
            // - PARTNER_SERVER_NAME: Uses hostname -s on target server
            // - DEPLOY_USER: Uses $SUDO_USER on target server
            return `# PDev-Live Configuration
# Generated by PDev Live Installer on ${new Date().toISOString()}

# ========================================
# PARTNER IDENTITY
# ========================================
PARTNER_DOMAIN=${config.partnerDomain}

# ========================================
# API CONFIGURATION
# ========================================
PDEV_LIVE_URL=https://${config.partnerDomain}/pdev/api
PDEV_BASE_URL=https://${config.partnerDomain}/pdev
PDEV_API_PORT=3077
PDEV_API_HOST=0.0.0.0

# ========================================
# SERVER INVENTORY
# ========================================
VALID_SERVERS=${config.validServers}
ALLOWED_IPS=${config.allowedIps}

# ========================================
# DATABASE CONFIGURATION
# ========================================
DB_HOST=localhost
DB_PORT=5432
DB_NAME=pdev_live
DB_USER=pdev_user
DB_PASSWORD=${config.dbPassword}

# ========================================
# AUTHENTICATION
# ========================================
PDEV_AUTH_USER=${config.authUser}
PDEV_AUTH_PASSWORD=${config.authPassword}
SESSION_SECRET=${config.sessionSecret}

# ========================================
# DEPLOYMENT PATHS
# ========================================
FRONTEND_DEPLOY_PATH=/var/www/${config.partnerDomain}/pdev
FRONTEND_BACKUP_PATH=/var/www/${config.partnerDomain}/pdev-backups
BACKEND_SERVICE_PATH=/opt/services/pdev-live
LOG_PATH=/opt/services/pdev-live/logs

# ========================================
# SSL/TLS CONFIGURATION
# ========================================
SSL_CERT_PATH=/etc/letsencrypt/live/${config.partnerDomain}/fullchain.pem
SSL_KEY_PATH=/etc/letsencrypt/live/${config.partnerDomain}/privkey.pem

# ========================================
# FEATURE FLAGS
# ========================================
ENABLE_AUTO_UPDATES=true
ENABLE_TELEMETRY=false
ENABLE_DEBUG_MODE=false

# ========================================
# BACKUP RETENTION
# ========================================
BACKUP_KEEP_DAYS=30
BACKUP_MAX_COUNT=10

# ========================================
# PM2 CONFIGURATION
# ========================================
PM2_APP_NAME=pdev-live
PM2_INSTANCES=1
PM2_MAX_MEMORY_RESTART=512M
`;
        }

        function initTerminal() {
            // DEFENSIVE CHECK: Verify container exists
            const container = document.getElementById('terminal-container');
            if (!container) {
                console.error('[FATAL] Terminal container element not found');
                showStatus('error', 'Terminal initialization failed: container not found');
                return false;
            }

            // DEFENSIVE CHECK: Verify xterm.js loaded
            if (typeof Terminal === 'undefined' || typeof FitAddon === 'undefined') {
                console.error('[FATAL] xterm.js libraries failed to load');
                showStatus('error', 'Terminal initialization failed: libraries not loaded. Check your internet connection.');
                return false;
            }

            // PREVENT DOUBLE INITIALIZATION
            if (terminal) {
                console.warn('[WARN] Terminal already initialized, cleaning up old instance');
                cleanupTerminal();
            }

            try {
                container.classList.add('active');

                terminal = new Terminal({
                    cursorBlink: true,
                    fontSize: 14,
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    theme: {
                        background: '#1e1e1e',
                        foreground: '#d4d4d4'
                    }
                });

                const fitAddon = new FitAddon.FitAddon();
                terminal.loadAddon(fitAddon);
                terminal.open(container);

                // Force reflow before fit()
                container.offsetHeight;  // Trigger synchronous layout calculation

                // Use requestAnimationFrame for guaranteed paint
                requestAnimationFrame(() => {
                    try {
                        fitAddon.fit();
                    } catch (err) {
                        console.error('[ERROR] Terminal fit failed:', err);
                    }
                });

                // MEMORY LEAK PREVENTION: Store resize handler for cleanup
                const resizeHandler = () => {
                    requestAnimationFrame(() => {
                        try {
                            fitAddon.fit();
                        } catch (err) {
                            console.error('[ERROR] Terminal resize fit failed:', err);
                        }
                    });
                };

                window.addEventListener('resize', resizeHandler);

                // Store handler for cleanup (attach to terminal object)
                terminal._resizeHandler = resizeHandler;

                return true;

            } catch (err) {
                console.error('[FATAL] Terminal initialization failed:', err);
                showStatus('error', 'Terminal initialization failed: ' + err.message);
                terminal = null;  // Ensure terminal is null on failure
                return false;
            }
        }

        // CLEANUP FUNCTION
        function cleanupTerminal() {
            if (!terminal) return;

            try {
                // Remove resize listener
                if (terminal._resizeHandler) {
                    window.removeEventListener('resize', terminal._resizeHandler);
                }

                // Dispose terminal instance
                terminal.dispose();
                terminal = null;

            } catch (err) {
                console.error('[ERROR] Terminal cleanup failed:', err);
            }
        }

        async function connectWebSocket(config) {
            showStatus('info', 'Requesting installation token...');

            try {
                // Request token from server
                const tokenRes = await fetch('/pdev/installer/token', { method: 'POST' });
                if (!tokenRes.ok) {
                    throw new Error('Failed to obtain installation token');
                }
                const tokenData = await tokenRes.json();
                const token = tokenData.token;

                // For project mode, use sourceAuth from token response
                // Note: config.config is the nested config object that server expects
                if (config.config && config.config.pendingSourceAuth && tokenData.sourceAuth) {
                    config.config.authUser = tokenData.sourceAuth.user;
                    config.config.authPassword = tokenData.sourceAuth.password;
                    delete config.config.pendingSourceAuth;
                } else if (config.config && config.config.pendingSourceAuth) {
                    // Fallback if source server doesn't provide auth
                    config.config.authUser = 'pdev';
                    config.config.authPassword = '';
                    delete config.config.pendingSourceAuth;
                    showStatus('warning', 'Source server auth not configured');
                }

                showStatus('info', 'Connecting to server...');

                // SECURITY: Enforce wss:// in production (not localhost)
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                if (window.location.hostname !== 'localhost' &&
                    window.location.hostname !== '127.0.0.1' &&
                    protocol === 'ws:') {
                    showStatus('error', 'Secure connection required. Please use HTTPS.');
                    return;
                }

                const wsUrl = `${protocol}//${window.location.host}/pdev/webssh?token=${token}`;

                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    showStatus('success', 'Connected! Starting installation...');
                    ws.send(JSON.stringify({ type: 'auth', ...config }));
                };
            } catch (err) {
                showStatus('error', 'Connection failed: ' + err.message);
                return;
            }

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'output') {
                    if (terminal) {
                        terminal.write(data.data);
                    } else {
                        console.error('[ERROR] Terminal not initialized, cannot write output');
                    }
                } else if (data.type === 'error') {
                    showStatus('error', data.message);
                    if (terminal) {
                        terminal.write(`\r\n\x1b[31mError: ${data.message}\x1b[0m\r\n`);
                    }
                } else if (data.type === 'success') {
                    showStatus('success', 'Installation completed successfully!');
                    if (terminal) {
                        terminal.write(`\r\n\x1b[32m‚úÖ Installation complete!\x1b[0m\r\n`);
                    }
                }
            };

            ws.onerror = (error) => {
                showStatus('error', 'WebSocket connection failed. Please check your network and try again.');
                if (terminal) {
                    terminal.write('\r\n\x1b[31mWebSocket connection error\x1b[0m\r\n');
                }
            };

            ws.onclose = () => {
                if (terminal) {
                    terminal.write('\r\n\x1b[33mConnection closed\x1b[0m\r\n');
                }
                cleanupTerminal();
            };
        }
    </script>
</body>
</html>
