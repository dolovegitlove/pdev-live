<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Library - PDev Live</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="pdev-live.css">
    <link rel="stylesheet" href="projects-specific.css">
</head>
<body>
    <!-- Navigation Header -->
    <nav class="nav-header">
        <a href="/pdev/" class="nav-logo">
            <div class="nav-logo-icon">P</div>
            <span>PDev Suite</span>
        </a>
        <div class="nav-links">
            <a href="/pdev/live/" class="nav-link">Live</a>
            <a href="/pdev/live/projects.html" class="nav-link active">Projects</a>
            <a href="/pdev/live/docs.html" class="nav-link">Docs</a>
            <a href="/pdev/live/settings.html" class="nav-link">Settings</a>
        </div>
    </nav>

    <div class="container">
        <header class="page-header">
            <div class="header-left">
                <h1 class="page-title">Project Library</h1>
                <p class="page-subtitle">Browse all PDev pipeline projects and their docs</p>
            </div>
            <div class="header-right">
                <span class="project-count" id="projectCount">-</span>
                <span class="project-count-label">projects</span>
                <button type="button" class="btn btn-primary add-project-btn" onclick="openAddProjectModal()" aria-label="Add new project">+ Add Project</button>
            </div>
        </header>

        <!-- Search/Filter Controls -->
        <section class="filter-section" role="search">
            <div class="search-box">
                <label for="searchInput" class="visually-hidden">Search projects</label>
                <input
                    type="search"
                    id="searchInput"
                    class="search-input"
                    placeholder="Search projects..."
                    aria-describedby="searchHelp"
                >
                <span id="searchHelp" class="visually-hidden">Type to filter projects by name</span>
            </div>
            <div class="filter-box">
                <label for="serverFilter" class="visually-hidden">Filter by server</label>
                <select id="serverFilter" class="filter-select" aria-describedby="filterHelp">
                    <option value="">All servers</option>
                </select>
                <span id="filterHelp" class="visually-hidden">Select a server to filter projects</span>
            </div>
        </section>

        <!-- Projects Grid -->
        <section class="projects-section" id="projectsSection" aria-label="Project list" aria-live="polite">
            <!-- Loading state -->
            <div class="loading-state" id="loadingState">
                <div class="skeleton-card" aria-hidden="true">
                    <div class="skeleton skeleton-badge"></div>
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text"></div>
                </div>
                <div class="skeleton-card" aria-hidden="true">
                    <div class="skeleton skeleton-badge"></div>
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text"></div>
                </div>
                <div class="skeleton-card" aria-hidden="true">
                    <div class="skeleton skeleton-badge"></div>
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text"></div>
                </div>
                <span class="visually-hidden" role="status">Loading projects...</span>
            </div>

            <!-- Empty state -->
            <div class="empty-state hidden" id="emptyState">
                <div class="icon" aria-hidden="true">üìÅ</div>
                <h3>Your project library is empty</h3>
                <p>Each time you run a PDev pipeline command, your project appears here.</p>
                <p class="empty-state-hint">Start your first pipeline:</p>
                <code class="hint-code">/pdev start my-project</code>
            </div>

            <!-- No results state -->
            <div class="empty-state hidden" id="noResultsState">
                <div class="icon" aria-hidden="true">üîç</div>
                <h3>No matching projects</h3>
                <p class="empty-state-hint">Try adjusting your search or filter.</p>
                <button type="button" class="btn btn-outline" onclick="clearFilters()">Clear Filters</button>
            </div>

            <!-- Error state -->
            <div class="error-state hidden" id="errorState">
                <div class="icon" aria-hidden="true">‚ö†Ô∏è</div>
                <h3>Couldn't load projects</h3>
                <p class="error-hint" id="errorMessage">Please check your connection and try again.</p>
                <button type="button" class="btn btn-outline" onclick="loadProjects()">Try Again</button>
            </div>

            <!-- Projects grid container -->
            <div class="projects-grid" id="projectsContainer" role="list"></div>
        </section>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal hidden" role="dialog" aria-labelledby="addProjectTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="addProjectTitle">Add New Project</h3>
                <button type="button" class="modal-close" onclick="closeAddProjectModal()" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" placeholder="my-project" pattern="[a-zA-Z0-9_-]+" required aria-describedby="projectNameHelp">
                    <small id="projectNameHelp" class="form-help">Letters, numbers, dashes, and underscores only</small>
                </div>
                <div class="form-group">
                    <label for="projectServer">Server</label>
                    <select id="projectServer" required>
                        <option value="">Select server...</option>
                        <option value="cfree">cfree</option>
                        <option value="ittz">ittz</option>
                        <option value="acme">acme</option>
                        <option value="rmlve">rmlve</option>
                        <option value="wdress">wdress</option>
                        <option value="djm">djm</option>
                    </select>
                </div>
                <div id="addProjectError" class="error-message hidden" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeAddProjectModal()">Cancel</button>
                <button type="button" class="btn btn-primary" id="createProjectBtn" onclick="createProject()">Create Project</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/pdev';
        let allProjects = [];

        // Security: HTML escape helper for dynamic data
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Format relative time
        function timeAgo(dateString) {
            if (!dateString) return 'No activity';
            const seconds = Math.floor((Date.now() - new Date(dateString).getTime()) / 1000);

            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return new Date(dateString).toLocaleDateString();
        }

        // Show/hide element utilities
        function showElement(el) { el.classList.remove('hidden'); }
        function hideElement(el) { el.classList.add('hidden'); }

        // Render a single project card with action buttons
        function renderProjectCard(project) {
            const lastActivity = timeAgo(project.last_activity);
            const datetime = project.last_activity || '';
            const fullDate = project.last_activity
                ? new Date(project.last_activity).toLocaleString()
                : 'No activity';
            const docCount = project.total_steps || 0;
            const sessionCount = project.session_count || 0;
            const hasSession = project.has_active_session || false;

            return `
                <div class="project-card" role="listitem" aria-label="${escapeHtml(project.project_name)} project on ${escapeHtml(project.server_origin)}">
                    <div class="project-card-header">
                        <span class="server-badge">${escapeHtml(project.server_origin)}</span>
                        <span class="doc-count">${escapeHtml(String(docCount))} docs</span>
                    </div>
                    <div class="project-card-body">
                        <h3 class="project-name">${escapeHtml(project.project_name)}</h3>
                        <div class="project-meta">
                            <span class="session-count">${escapeHtml(String(sessionCount))} sessions</span>
                            <time datetime="${escapeHtml(datetime)}" title="${escapeHtml(fullDate)}">${escapeHtml(lastActivity)}</time>
                        </div>
                    </div>
                    <div class="project-card-actions">
                        <a href="project.html?server=${encodeURIComponent(project.server_origin)}&project=${encodeURIComponent(project.project_name)}" class="btn btn-outline btn-sm" aria-label="View ${escapeHtml(project.project_name)} documents">View</a>
                        <button type="button" class="btn btn-outline btn-sm" onclick="shareProject('${escapeHtml(project.server_origin)}', '${escapeHtml(project.project_name)}')" aria-label="Share ${escapeHtml(project.project_name)}">Share</button>
                        <button type="button" class="btn btn-primary btn-sm ${hasSession ? '' : 'btn-disabled'}" onclick="resumeProject('${escapeHtml(project.server_origin)}', '${escapeHtml(project.project_name)}')" ${hasSession ? '' : 'disabled'} aria-label="Resume ${escapeHtml(project.project_name)} session" title="${hasSession ? 'Resume last session' : 'No active session to resume'}">Resume</button>
                    </div>
                </div>
            `;
        }

        // Populate server filter dropdown
        function populateServerFilter(projects) {
            const select = document.getElementById('serverFilter');
            const servers = [...new Set(projects.map(p => p.server_origin))].sort();

            // Only populate if not already done
            if (select.options.length <= 1) {
                servers.forEach(server => {
                    const option = document.createElement('option');
                    option.value = server;
                    option.textContent = server;
                    select.appendChild(option);
                });
            }
        }

        // Apply filters and render
        function applyFiltersAndRender() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const serverFilter = document.getElementById('serverFilter').value;
            const container = document.getElementById('projectsContainer');
            const emptyState = document.getElementById('emptyState');
            const noResultsState = document.getElementById('noResultsState');

            hideElement(emptyState);
            hideElement(noResultsState);

            let filtered = allProjects;

            // Filter by server
            if (serverFilter) {
                filtered = filtered.filter(p => p.server_origin === serverFilter);
            }

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(p =>
                    p.project_name.toLowerCase().includes(searchTerm)
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = '';
                if (allProjects.length === 0) {
                    showElement(emptyState);
                } else {
                    showElement(noResultsState);
                }
                document.getElementById('projectCount').textContent = '0';
                return;
            }

            container.innerHTML = filtered.map(renderProjectCard).join('');
            document.getElementById('projectCount').textContent = String(filtered.length);
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('serverFilter').value = '';
            applyFiltersAndRender();
        }

        // Load projects from API
        async function loadProjects() {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const noResultsState = document.getElementById('noResultsState');
            const errorState = document.getElementById('errorState');
            const container = document.getElementById('projectsContainer');

            showElement(loadingState);
            hideElement(emptyState);
            hideElement(noResultsState);
            hideElement(errorState);
            container.innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/projects`);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: Failed to load projects`);
                }

                const data = await response.json();
                hideElement(loadingState);

                allProjects = data.projects || [];

                if (allProjects.length === 0) {
                    showElement(emptyState);
                    document.getElementById('projectCount').textContent = '0';
                    return;
                }

                populateServerFilter(allProjects);
                applyFiltersAndRender();

            } catch (error) {
                console.error('Failed to load projects:', error);
                hideElement(loadingState);
                showElement(errorState);
                document.getElementById('errorMessage').textContent =
                    error.message || 'Please check your connection and try again.';
            }
        }

        // Debounce utility for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();

            // Search input with debounce
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', debounce(applyFiltersAndRender, 300));

            // Server filter change
            const serverFilter = document.getElementById('serverFilter');
            serverFilter.addEventListener('change', applyFiltersAndRender);

            // Close modal on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeAddProjectModal();
            });
        });

        // Add Project Modal Functions
        function openAddProjectModal() {
            document.getElementById('addProjectModal').classList.remove('hidden');
            document.getElementById('projectName').value = '';
            document.getElementById('projectServer').value = '';
            hideElement(document.getElementById('addProjectError'));
            document.getElementById('createProjectBtn').disabled = false;
            document.getElementById('createProjectBtn').textContent = 'Create Project';
            document.getElementById('projectName').focus();
        }

        function closeAddProjectModal() {
            document.getElementById('addProjectModal').classList.add('hidden');
        }

        async function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const server = document.getElementById('projectServer').value;
            const errorEl = document.getElementById('addProjectError');
            const btn = document.getElementById('createProjectBtn');

            // Validate inputs
            if (!name) {
                errorEl.textContent = 'Please enter a project name';
                showElement(errorEl);
                return;
            }

            if (!/^[a-zA-Z0-9_-]+$/.test(name)) {
                errorEl.textContent = 'Project name can only contain letters, numbers, dashes, and underscores';
                showElement(errorEl);
                return;
            }

            if (!server) {
                errorEl.textContent = 'Please select a server';
                showElement(errorEl);
                return;
            }

            hideElement(errorEl);
            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                const response = await fetch(`${API_BASE}/api/projects/init`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, server })
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(data.error || 'Failed to create project');
                }

                const data = await response.json();
                btn.textContent = 'Created!';

                // Redirect to the new project
                setTimeout(() => {
                    window.location.href = `project.html?server=${encodeURIComponent(server)}&project=${encodeURIComponent(name)}`;
                }, 500);

            } catch (error) {
                console.error('Failed to create project:', error);
                errorEl.textContent = error.message || 'Failed to create project. Please try again.';
                showElement(errorEl);
                btn.disabled = false;
                btn.textContent = 'Create Project';
            }
        }

        // Share project - redirect to project page with share modal open
        function shareProject(server, project) {
            window.location.href = `project.html?server=${encodeURIComponent(server)}&project=${encodeURIComponent(project)}&action=share`;
        }

        // Resume project session
        async function resumeProject(server, project) {
            try {
                const response = await fetch(`${API_BASE}/api/sessions/resume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ server, project })
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(data.error || 'Failed to resume session');
                }

                // Redirect to live view
                window.location.href = `/pdev/live/?server=${encodeURIComponent(server)}&project=${encodeURIComponent(project)}`;

            } catch (error) {
                console.error('Failed to resume session:', error);
                alert('Could not resume session: ' + error.message);
            }
        }
    </script>
</body>
</html>
