<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDev Live - Session</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" integrity="sha384-wH75j6z1lH97ZOpMOInqhgKzFkAInZPPSPlZpYKYTOqsaizPvhQZmAtLcPKXpLyH" crossorigin="anonymous">
    <link rel="stylesheet" href="pdev-live.css">
    <link rel="stylesheet" href="session-specific.css">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"></head>
<body>
    <nav class="nav-header">
        <a href="/pdev/" class="nav-logo">
            <div class="nav-logo-icon">P</div>
            <span>PDev Suite</span>
        </a>
        <div class="nav-links">
            <a href="/pdev/live/" class="nav-link">Live</a>
            <a href="/pdev/live/projects.html" class="nav-link">Projects</a>
            <a href="/pdev/live/docs.html" class="nav-link">Docs</a>
            <a href="/pdev/live/settings.html" class="nav-link">Settings</a>
        </div>
    </nav>
    <div class="container">
        <header>
            <div class="logo">PDev Live</div>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Loading...</span>
            </div>
        </header>

        <div class="session-header" id="sessionHeader">
            <span class="badge" id="sessionBadge">Loading...</span>
            <div class="session-meta" id="sessionMeta">Loading session...</div>
        </div>

        <div class="main-content">
            <div class="output-panel">
                <div class="output-header">
                    <span id="outputTitle">Output</span>
                    <button class="btn btn-outline" onclick="copyOutput()">Copy</button>
                </div>
                <div class="output-body" id="outputBody">
                    <div class="empty-state">
                        <div class="icon">‚è≥</div>
                        <p>Loading session data...</p>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-card">
                    <h3>Documents (<span id="stepCount">0</span>)</h3>
                    <ul class="step-list" id="stepList">
                        <li style="color: var(--muted);">Loading...</li>
                    </ul>
                </div>
                <div class="sidebar-card" id="docsCard" style="display: none;">
                    <h3>Documents</h3>
                    <ul class="step-list" id="docsList"></ul>
                </div>


                <div class="sidebar-card">
                    <h3>Actions</h3>
                    <div class="actions-list">
                        <button class="btn btn-primary share-btn" onclick="openShareModal()" id="shareActionBtn">Share with Client</button>
                        <a href="/pdev/live/" class="btn btn-outline action-link">Dashboard</a>
                        <a href="/pdev/" class="btn btn-outline action-link">PDev Docs</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share Session</h3>
                <button class="modal-close" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="shareEmail">Email (optional)</label>
                    <input type="email" id="shareEmail" placeholder="client@example.com">
                </div>
                <div class="form-group">
                    <label for="shareExpiry">Link expires in</label>
                    <select id="shareExpiry">
                        <option value="24">24 hours</option>
                        <option value="48">48 hours</option>
                        <option value="72" selected>72 hours (3 days)</option>
                        <option value="168">1 week</option>
                        <option value="336">2 weeks</option>
                        <option value="720">30 days</option>
                    </select>
                </div>
                <div id="shareResult" class="share-result hidden">
                    <label>Share Link</label>
                    <div class="share-link-row">
                        <input type="text" id="shareLink" readonly>
                        <button class="btn" onclick="copyShareLink(event)">Copy</button>
                    </div>
                    <p id="shareExpires" class="share-expires"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeShareModal()">Cancel</button>
                <button class="btn btn-primary" id="shareBtn" onclick="createShareLink()">Create Link</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js" integrity="sha384-NNQgBjjuhtXzPmmy4gurS5X7P4uTt1DThyevz4Ua0IVK5+kazYQI1W27JHjbbxQz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha384-F/bZzf7p3Joyp5psL90p/p89AZJsndkSoGwRpXcZhleCWhd8SnRuoYo4d0yirjJp" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" integrity="sha384-cwS6YdhLI7XS60eoDiC+egV0qHp8zI+Cms46R0nbn8JrmoAzV9uFL60etMZhAnSu" crossorigin="anonymous"></script>
    <script>
        // Security: HTML escape helper for dynamic data
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        const API_BASE = '/pdev';
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('id') || params.get('guest');
        const guestToken = params.get('guest');
        
        let eventSource = null;
        let session = null;
        let currentStepIndex = -1;

        // Configure marked
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Extract a label from step content
        function extractStepLabel(step, index) {
            // Priority 1: document name
            if (step.document_name) return step.document_name;
            
            // Priority 2: Extract heading from content (NOT phase info - that's shown separately)
            const content = step.content_markdown || step.content || '';
            
            // Look for ## heading first (most common in steps)
            const h2Match = content.match(/^##\s+(.+)$/m);
            if (h2Match) {
                const heading = h2Match[1].trim();
                // Skip if it's just "Phase X:" prefix
                if (!heading.match(/^Phase \d+:/)) {
                    return heading.substring(0, 40);
                }
            }
            
            // Look for # heading
            const h1Match = content.match(/^#\s+(.+)$/m);
            if (h1Match) {
                const heading = h1Match[1].trim();
                if (!heading.match(/^Phase \d+:/)) {
                    return heading.substring(0, 40);
                }
            }
            
            // Look for **bold** at start of any line
            const boldMatch = content.match(/^\*\*([^*]+)\*\*/m);
            if (boldMatch) return boldMatch[1].substring(0, 40);
            
            // First non-empty, non-phase line
            const lines = content.split('\n');
            for (const line of lines) {
                const clean = line.replace(/[#*`-]/g, '').trim();
                if (clean && clean.length > 3 && !clean.match(/^Phase \d+:/) && !clean.match(/^pdev_version/)) {
                    return clean.substring(0, 35) + (clean.length > 35 ? '...' : '');
                }
            }
            
            // Fallback: Step number
            return 'Step ' + (index + 1);
        }
        async function init() {
            if (!sessionId) {
                showError('This session link seems incomplete. Please check the URL you received, or return to the Dashboard to find your session.');
                return;
            }

            try {
                // For guest access, validate token first
                if (guestToken) {
                    const guestRes = await fetch(`${API_BASE}/guest/${guestToken}`);
                    if (!guestRes.ok) {
                        showError('This link has expired or is no longer available. Ask the project owner for a new link, or log in to access your sessions.');
                        return;
                    }
                }

                // Fetch session data
                const res = await fetch(`${API_BASE}/sessions/${sessionId}`);
                if (!res.ok) {
                    showError('We couldn\'t find this session. It may have been deleted. Visit the Dashboard to see your active sessions.');
                    return;
                }

                session = await res.json();
                renderSession();
                loadManifest();
                renderSteps();
                // renderDocSteps();
                
                // Show latest output
                if (session.steps && session.steps.length > 0) {
                    // auto-scroll disabled
                }

                // Connect to SSE for live updates if session is active
                if (session.session_status === 'active') {
                    connectSSE();
                }
            } catch (err) {
                showError('Something went wrong loading this session. Please try refreshing the page. If the problem continues, check your network connection.');
            }
        }

        let sseReconnectAttempts = 0;
        const SSE_MAX_RECONNECT = 10;
        const SSE_BASE_DELAY = 3000;

        function connectSSE() {
            eventSource = new EventSource(`${API_BASE}/events/${sessionId}`);

            eventSource.onopen = () => {
                sseReconnectAttempts = 0; // Reset on successful connection
                document.getElementById('statusDot').className = 'status-dot connected';
                document.getElementById('statusText').textContent = 'Live';
            };

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleEvent(data);
            };

            eventSource.onerror = () => {
                eventSource.close();
                if (sseReconnectAttempts >= SSE_MAX_RECONNECT) {
                    document.getElementById('statusDot').className = 'status-dot';
                    document.getElementById('statusText').textContent = 'Disconnected';
                    console.warn('SSE: Max reconnection attempts reached');
                    return;
                }
                const delay = Math.min(SSE_BASE_DELAY * Math.pow(2, sseReconnectAttempts), 30000);
                sseReconnectAttempts++;
                document.getElementById('statusDot').className = 'status-dot';
                document.getElementById('statusText').textContent = 'Reconnecting...';
                setTimeout(connectSSE, delay);
            };
        }

        function handleEvent(data) {
            if (data.type === 'step' && data.step) {
                // Add new step
                if (!session.steps) session.steps = [];
                session.steps.push(data.step);
                renderSteps();
                // renderDocSteps();
                // Auto-show new step
                // auto-scroll disabled
            } else if (data.type === 'complete') {
                session.session_status = 'completed';
                renderSession();
                loadManifest();
                if (eventSource) eventSource.close();
            }
        }

        function renderSession() {
            const badge = document.getElementById('sessionBadge');
            const meta = document.getElementById('sessionMeta');
            
            const status = session.session_status || 'active';
            badge.textContent = session.command_type || 'Session';
            badge.className = 'badge ' + status;

            const started = new Date(session.started_at).toLocaleString();
            const project = session.project_name || 'Unknown';
            const server = session.server_origin || 'Unknown';
            
            meta.innerHTML = `
                <strong>${project}</strong> on ${server} &nbsp;|&nbsp; 
                Started: ${started}
                ${session.duration_seconds ? ` &nbsp;|&nbsp; Duration: ${session.duration_seconds}s` : ''}
            `;

            // Update status indicator
            if (status === 'active') {
                document.getElementById('statusDot').className = 'status-dot connected';
                document.getElementById('statusText').textContent = 'Live';
            } else {
                document.getElementById('statusDot').className = 'status-dot';
                document.getElementById('statusText').textContent = status;
            }
        }

        
        function renderSteps() {
            const list = document.getElementById('stepList');
            const countEl = document.getElementById('stepCount');
            
            if (!session || !session.steps || session.steps.length === 0) {
                list.innerHTML = '<li class="doc-item" style="color: var(--muted); cursor: default;">No documents yet</li>';
                countEl.textContent = '0';
                return;
            }

            const seenSections = new Set();
            let clickableCount = 0;
            
            list.innerHTML = session.steps.map((step, i) => {
                const type = step.step_type || step.type || 'output';
                let html = '';
                
                // Skip hook outputs and system noise
                if (step.content_markdown && (step.content_markdown.includes('pdevlivesync') || step.content_markdown.includes('Modified:'))) {
                    return '';
                }
                
                // Determine section name: document_name takes priority, then phase_name
                let sectionName = null;
                if (step.document_name && step.document_name.trim()) {
                    sectionName = step.document_name.trim().toUpperCase().replace(/_/g, ' ');
                } else if (step.phase_name && step.phase_name.trim()) {
                    sectionName = step.phase_name.trim();
                }
                
                // Only show section header if we haven't seen this section before
                if (sectionName && !seenSections.has(sectionName)) {
                    seenSections.add(sectionName);
                    html += '<li class="phase-header">' + sectionName + '</li>';
                }
                
                // Skip system steps that are just phase markers
                if (type === 'system' && step.phase_name && !step.document_name) {
                    return html;
                }
                
                // Clickable item
                clickableCount++;
                const label = extractStepLabel(step, i);
                const icon = type === 'document' ? 'üìÑ' : type === 'system' ? '‚öôÔ∏è' : 'üìù';
                const iconClass = type;
                const activeClass = i === currentStepIndex ? 'active' : '';
                
                html += '<li onclick="showStep(' + i + ')" class="doc-item ' + activeClass + '">' +
                    '<span class="step-icon ' + iconClass + '">' + icon + '</span>' +
                    '<span class="step-label" title="' + label + '">' + label + '</span>' +
                '</li>';
                
                return html;
            }).join('');
            
            countEl.textContent = clickableCount;
        }

        function showStep(index) {
            if (!session.steps || !session.steps[index]) return;
            
            currentStepIndex = index;
            const step = session.steps[index];
            const body = document.getElementById('outputBody');
            const title = document.getElementById('outputTitle');
            
            title.textContent = extractStepLabel(step, index);
            
            // Use pre-rendered HTML if available, otherwise render markdown
            // SECURITY: Always sanitize HTML content to prevent XSS
            if (step.content_html) {
                body.innerHTML = DOMPurify.sanitize(step.content_html);
            } else if (step.content_markdown || step.content) {
                body.innerHTML = DOMPurify.sanitize(marked.parse(step.content_markdown || step.content || ''));
            } else {
                body.innerHTML = '<p style="color: var(--muted);">No content</p>';
            }

            // Re-highlight code blocks
            body.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
            });

            // Update step list to show active
            renderSteps();
                // renderDocSteps();
        }

        function showError(msg) {
            document.getElementById('sessionHeader').innerHTML = `<span class="badge" style="background: #ef4444;">Error</span>`;
            document.getElementById('outputBody').innerHTML = `
                <div class="error-state">
                    <div class="icon">‚ùå</div>
                    <p>${msg}</p>
                </div>
            `;
            document.getElementById('statusDot').className = 'status-dot';
            document.getElementById('statusText').textContent = 'Error';
        }

        function copyOutput() {
            const body = document.getElementById('outputBody');
            navigator.clipboard.writeText(body.innerText);
            alert('Copied to clipboard!');
        }

        // Initialize
        // Load and render manifest documents
        async function loadManifest() {
            if (!session) return;
            const server = session.server_origin;
            const project = session.project_name;
            if (!server || !project) return;
            
            try {
                const res = await fetch(`${API_BASE}/manifests/${server}/${project}`);
                if (!res.ok) return;
                
                const manifest = await res.json();
                if (manifest && manifest.docs && Object.keys(manifest.docs).length > 0) {
                    renderDocs(manifest);
                }
            } catch (err) {
                console.log("No manifest:", err.message);
            }
        }

        function renderDocs(manifest) {
            const card = document.getElementById("docsCard");
            const list = document.getElementById("docsList");
            
            if (!manifest.docs || Object.keys(manifest.docs).length === 0) {
                card.style.display = "none";
                return;
            }
            
            card.style.display = "block";
            
            const docTypes = {
                ideation: { icon: "üí°", label: "Ideation" },
                spec: { icon: "üìã", label: "Product Spec" },
                sop: { icon: "üìù", label: "Development SOP" },
                benchmark: { icon: "üìä", label: "Benchmark" },
                design: { icon: "üé®", label: "Design System" },
                gap: { icon: "üîç", label: "Gap Analysis" },
                innov: { icon: "üöÄ", label: "Innovation" },
                caps: { icon: "‚öôÔ∏è", label: "Capabilities" }
            };
            
            list.innerHTML = Object.entries(manifest.docs).map(([type, fileName]) => {
                const meta = docTypes[type] || { icon: "üìÑ", label: type };
                return `<li style="justify-content: space-between;">
                    <span>${meta.icon} ${meta.label}</span>
                    <span style="color: var(--muted); font-size: 0.75rem;">${fileName}</span>
                </li>`;
            }).join("");
        }

        // Render documents from steps (pushed via pdev-live doc)
        function renderDocSteps() {
            const card = document.getElementById("docsCard");
            const list = document.getElementById("docsList");

            if (!session || !session.steps) return;

            // Filter for document-type steps
            const docSteps = session.steps.filter(s => s.step_type === 'document' || s.type === 'document');

            if (docSteps.length === 0) return;

            card.style.display = "block";

            list.innerHTML = docSteps.map((step, origIndex) => {
                // Find the real index in all steps
                const realIndex = session.steps.indexOf(step);
                const name = step.document_name || extractStepLabel(step, realIndex);
                const icon = name.includes('BENCHMARK') ? 'üìä' :
                            name.includes('IDEATION') ? 'üí°' :
                            name.includes('SPEC') ? 'üìã' :
                            name.includes('SOP') ? 'üìù' :
                            name.includes('GAP') ? 'üîç' :
                            name.includes('INNOV') ? 'üöÄ' :
                            name.includes('CAPS') ? '‚öôÔ∏è' :
                            name.includes('DESIGN') ? 'üé®' : 'üìÑ';
                return '<li onclick="showStep(' + realIndex + ')" class="doc-clickable">' +
                    '<span>' + icon + ' ' + name + '</span>' +
                '</li>';
            }).join("");
        }

        // Share Modal Functions
        function openShareModal() {
            var modal = document.getElementById('shareModal');
            var result = document.getElementById('shareResult');
            var emailInput = document.getElementById('shareEmail');
            var btn = document.getElementById('shareBtn');

            if (!modal || !result || !emailInput || !btn) {
                console.error('Share modal: Required DOM elements not found');
                return;
            }

            modal.classList.remove('hidden');
            result.classList.add('hidden');
            emailInput.value = '';
            btn.disabled = false;
            btn.textContent = 'Create Link';
        }

        function closeShareModal() {
            var modal = document.getElementById('shareModal');
            if (modal) modal.classList.add('hidden');
        }

        async function createShareLink() {
            var emailInput = document.getElementById('shareEmail');
            var expirySelect = document.getElementById('shareExpiry');
            var btn = document.getElementById('shareBtn');

            if (!emailInput || !expirySelect || !btn) return;

            var email = emailInput.value.trim();
            var hours = expirySelect.value;

            if (!sessionId) {
                alert('No active session to share');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                // Request share token from server (origin-validated)
                var tokenRes = await fetch(API_BASE + '/share-token', { method: 'POST', credentials: 'same-origin' });
                if (!tokenRes.ok) throw new Error('Not authorized to create share links');
                var tokenData = await tokenRes.json();

                var res = await fetch(API_BASE + '/guest-links', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Share-Token': tokenData.token
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        email: email || null,
                        expiresInHours: parseInt(hours, 10)
                    })
                });

                if (!res.ok) {
                    var errData = await res.json().catch(function() { return {}; });
                    throw new Error(errData.error || 'Failed to create link');
                }

                var data = await res.json();
                var baseUrl = window.location.origin + '/pdev/live/session.html';
                var shareUrl = baseUrl + '?guest=' + encodeURIComponent(data.token);

                var linkInput = document.getElementById('shareLink');
                var expiresEl = document.getElementById('shareExpires');
                var resultEl = document.getElementById('shareResult');

                if (linkInput) linkInput.value = shareUrl;
                if (expiresEl) expiresEl.textContent = 'Expires: ' + new Date(data.expiresAt).toLocaleString();
                if (resultEl) resultEl.classList.remove('hidden');

                btn.textContent = 'Link Created';
                setTimeout(function() {
                    btn.disabled = false;
                    btn.textContent = 'Create Another';
                }, 2000);

            } catch (err) {
                console.error('Share link creation failed:', err);
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'Create Link';
            }
        }

        async function copyShareLink(evt) {
            var linkInput = document.getElementById('shareLink');
            if (!linkInput) return;

            var text = linkInput.value;

            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    linkInput.select();
                    document.execCommand('copy');
                }

                if (evt && evt.target) {
                    var btn = evt.target;
                    var orig = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(function() { btn.textContent = orig; }, 2000);
                }
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Failed to copy. Please select and copy manually.');
            }
        }

        function checkShareAccess() {
            // Hide share button for guest users
            if (guestToken) {
                document.body.classList.add('guest-view');
            }
        }

        init();
        checkShareAccess();
    </script>
<script src="version-check.js"></script>
</body>
</html>
