<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDev - Project View</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="pdev-live.css">
    <link rel="stylesheet" href="project-specific.css">
</head>
<body>
    <nav class="nav-header">
        <a href="/pdev/" class="nav-logo">
            <div class="nav-logo-icon">P</div>
            <span>PDev Suite</span>
        </a>
        <div class="nav-links">
            <a href="/pdev/live/" class="nav-link">Live</a>
            <a href="/pdev/live/projects.html" class="nav-link active">Projects</a>
            <a href="/pdev/live/docs.html" class="nav-link">Docs</a>
            <a href="/pdev/live/settings.html" class="nav-link">Settings</a>
        </div>
    </nav>
    <div class="container">
        <div class="breadcrumb breadcrumb-container">
            <a href="index.html">Dashboard</a>
            <span>/</span>
            <span id="breadcrumb-project">Project</span>
        </div>
        <div class="project-header">
            <div class="project-title" id="project-name">Loading...</div>
            <div class="project-meta">
                <strong>Server:</strong> <span id="project-server">-</span>
                <span> | </span>
                <strong>Last updated:</strong> <span id="project-updated">-</span>
            </div>
        </div>
        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-card pipeline-progress-card">
                    <h3>Pipeline Progress</h3>
                    <div class="pipeline-progress" id="pipeline-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar progress-0" id="progress-bar"></div>
                        </div>
                        <div class="progress-text" id="progress-text">Loading...</div>
                    </div>
                </div>
                <div class="sidebar-card">
                    <h3>Pipeline Documents</h3>
                    <ul class="doc-list" id="doc-list">
                        <li class="loading loading-pulse">Loading docs...</li>
                    </ul>
                </div>
                <div class="sidebar-card">
                    <h3>Recent Sessions</h3>
                    <ul class="session-list" id="session-list">
                        <li class="loading loading-pulse">Loading...</li>
                    </ul>
                </div>
                <div class="sidebar-card">
                    <h3>Actions</h3>
                    <div class="actions-list">
                        <button class="btn btn-primary" onclick="openShareModal()" id="shareBtn">Share with Client</button>
                        <a href="/pdev/live/" class="btn btn-outline action-link">Dashboard</a>
                    </div>
                </div>
            </div>
            <div class="output-panel">
                <div class="output-header">
                    <div class="header-title">
                        <span id="doc-title">Select a document</span>
                        <span id="doc-version"></span>
                    </div>
                    <div class="doc-actions hidden" id="docActions">
                        <button type="button" class="btn-icon" id="copyBtn" aria-label="Copy raw markdown to clipboard" title="Copy" onclick="copyDocContent()">üìã</button>
                        <button type="button" class="btn-icon" aria-label="Download as markdown file" title="Download .md" onclick="downloadDocContent()">‚¨áÔ∏è</button>
                        <button type="button" class="btn-icon" aria-label="Export as PDF" title="Export PDF" onclick="exportToPDF()">üìÑ</button>
                    </div>
                </div>
                <div class="output-body" id="doc-content">
                    <div class="empty-state">
                        <h2>Select a document</h2>
                        <p>Click on a document from the sidebar to view its contents.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script>
        // Security: HTML escape helper for dynamic data
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        const API_BASE = '/pdev';
        // SINGLE SOURCE OF TRUTH: Load from API, fallback to hardcoded
        let PIPELINE_DOCS = [
            { type: 'IDEATION', name: 'IDEATION.md', icon: 'üí°', phase: 1, cmd: '/idea' },
            { type: 'BENCHMARK', name: 'BENCHMARK.md', icon: 'üìä', phase: 2, cmd: '/bmrk' },
            { type: 'GAP_ANALYSIS', name: 'GAP_ANALYSIS.md', icon: 'üîç', phase: 3, cmd: '/gapa' },
            { type: 'INNOVATION', name: 'INNOVATION.md', icon: 'üöÄ', phase: 4, cmd: '/innov' },
            { type: 'CAPABILITIES', name: 'CAPABILITIES.md', icon: '‚öôÔ∏è', phase: 5, cmd: '/caps' },
            { type: 'PRODUCT_SPEC', name: 'PRODUCT_SPEC.md', icon: 'üìã', phase: 6, cmd: '/spec' },
            { type: 'DESIGN_SYSTEM', name: 'DESIGN_SYSTEM.md', icon: 'üé®', phase: 7, cmd: '/bmrk design' },
            { type: 'DEVELOPMENT_SOP', name: 'DEVELOPMENT_SOP.md', icon: 'üìù', phase: 8, cmd: '/sop' },
            { type: 'EVALUATION', name: 'EVALUATION.md', icon: '‚úÖ', phase: 9, cmd: '/eval' }
        ];
        const params = new URLSearchParams(window.location.search);
        const projectName = params.get('project');
        const serverName = params.get('server') || 'cfree';
        const guestToken = params.get('guest');
        const isGuestView = !!guestToken;
        let projectDocs = {};
        let currentDocRawContent = '';
        let currentDocType = '';

        async function init() {
            if (!projectName) {
                document.getElementById('project-name').textContent = 'No project specified';
                return;
            }
            // Load contract from API (single source of truth)
            try {
                const contractRes = await fetch(API_BASE + '/contract', { credentials: 'same-origin' });
                if (contractRes.ok) {
                    const contract = await contractRes.json();
                    if (contract.PIPELINE_DOCS && contract.PIPELINE_DOCS.length > 0) {
                        PIPELINE_DOCS = contract.PIPELINE_DOCS;
                        console.log('[PDev] Loaded doc contract from API:', PIPELINE_DOCS.length, 'types');
                    }
                }
            } catch (e) {
                console.warn('[PDev] Using fallback doc contract');
            }
            document.getElementById('project-name').textContent = projectName;
            document.getElementById('breadcrumb-project').textContent = projectName;
            document.getElementById('project-server').textContent = serverName;

            // Hide share functionality for guest viewers (guests cannot create new share links)
            if (isGuestView) {
                var shareBtn = document.getElementById('shareBtn');
                if (shareBtn) shareBtn.classList.add('hidden');
            }

            await Promise.all([loadProjectDocs(), loadProjectSessions()]);
        }
        
        async function loadProjectDocs() {
            try {
                const response = await fetch(API_BASE + '/projects/' + serverName + '/' + projectName + '/docs', { credentials: 'same-origin' });
                if (!response.ok) { renderDocList({}); return; }
                projectDocs = await response.json();
                renderDocList(projectDocs);
                if (projectDocs.lastModified) {
                    document.getElementById('project-updated').textContent = new Date(projectDocs.lastModified).toLocaleString();
                }
            } catch (err) {
                console.error('Failed to load docs:', err);
                renderDocList({});
            }
        }
        
        // Format date as "12/31 10:03a"
        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const month = d.getMonth() + 1;
            const day = d.getDate();
            let hours = d.getHours();
            const mins = d.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'p' : 'a';
            hours = hours % 12 || 12;
            return month + '/' + day + ' ' + hours + ':' + mins + ampm;
        }

        function renderDocList(docs) {
            const list = document.getElementById('doc-list');
            list.innerHTML = '';
            const hasAnyDocs = Object.keys(docs).some(k => k !== 'lastModified');

            // Update pipeline progress indicator
            var completedDocs = PIPELINE_DOCS.filter(function(d) { return docs[d.type]; }).length;
            var totalDocs = PIPELINE_DOCS.length;
            var progressPercent = Math.round((completedDocs / totalDocs) * 100);
            var progressBar = document.getElementById('progress-bar');
            var progressText = document.getElementById('progress-text');
            if (progressBar && progressText) {
                progressBar.className = 'progress-bar';
                progressBar.setAttribute('data-progress', progressPercent);
                progressText.textContent = completedDocs + ' of ' + totalDocs + ' docs (' + progressPercent + '%)';
            }

            // Show onboarding if no docs exist
            if (!hasAnyDocs) {
                const onboarding = document.createElement('div');
                onboarding.className = 'onboarding-card';
                onboarding.innerHTML = '<h3>Start Your Pipeline</h3>' +
                    '<p>Begin by running <code>/idea ' + projectName + '</code> or <code>/eval ' + projectName + '</code> in Claude Code</p>';
                list.parentNode.insertBefore(onboarding, list);
            }

            PIPELINE_DOCS.forEach(doc => {
                const docData = docs[doc.type];
                const li = document.createElement('li');
                li.className = 'doc-item' + (docData ? '' : ' missing');
                const phaseBadge = '<span class="phase-badge">' + doc.phase + '</span>';
                if (docData) {
                    const versionStr = docData.version ? 'v' + docData.version : '';
                    const dateStr = docData.modified ? formatDateTime(docData.modified) : '';
                    const idStr = docData.id ? '#' + docData.id.substring(0, 6) : '';
                    const metaStr = [versionStr, dateStr, idStr].filter(Boolean).join(' ‚Ä¢ ');
                    li.innerHTML = '<div class="doc-name">' + phaseBadge + '<span class="icon">' + doc.icon + '</span>' + doc.name + '</div>' +
                        '<div class="doc-meta">' + metaStr + '</div>';
                    li.onclick = function() { selectDoc(doc.type, docData); };
                } else {
                    li.innerHTML = '<div class="doc-name">' + phaseBadge + '<span class="icon">' + doc.icon + '</span>' + doc.name +
                        '<span class="action-hint" title="Run this command to create">Run ' + doc.cmd + '</span></div>';
                    li.onclick = function() { showMissingDocHelp(doc); };
                }
                list.appendChild(li);
            });
            const firstDoc = PIPELINE_DOCS.find(d => docs[d.type]);
            if (firstDoc && docs[firstDoc.type]) selectDoc(firstDoc.type, docs[firstDoc.type]);
        }

        function showMissingDocHelp(doc) {
            document.querySelectorAll('.doc-item').forEach(el => el.classList.remove('active'));
            const items = document.querySelectorAll('.doc-item');
            const index = PIPELINE_DOCS.findIndex(d => d.type === doc.type);
            if (items[index]) items[index].classList.add('active');

            document.getElementById('doc-title').textContent = doc.name;
            document.getElementById('doc-version').textContent = '';
            document.getElementById('doc-content').innerHTML =
                '<div class="empty-state">' +
                '<h2>' + doc.icon + ' ' + doc.name.replace('.md', '') + '</h2>' +
                '<p class="help-content">This document hasn\'t been created yet.</p>' +
                '<p>To create it, run:</p>' +
                '<p class="help-command"><code>' + doc.cmd + ' ' + projectName + '</code></p>' +
                '<p class="help-phase">Phase ' + doc.phase + ' of 9 in the PDev pipeline</p>' +
                '</div>';
        }
        
        async function selectDoc(type, docData) {
            document.querySelectorAll('.doc-item').forEach(el => el.classList.remove('active'));
            const items = document.querySelectorAll('.doc-item');
            const index = PIPELINE_DOCS.findIndex(d => d.type === type);
            if (items[index]) items[index].classList.add('active');

            currentDocType = type;
            document.getElementById('doc-title').textContent = PIPELINE_DOCS.find(d => d.type === type)?.name || type;
            const versionStr = docData.version ? 'v' + docData.version : '';
            const dateStr = docData.modified ? formatDateTime(docData.modified) : '';
            const idStr = docData.id ? '#' + docData.id.substring(0, 6) : '';
            document.getElementById('doc-version').textContent = [versionStr, dateStr, idStr].filter(Boolean).join(' ‚Ä¢ ');

            if (docData.content) {
                currentDocRawContent = docData.content;
                document.getElementById('docActions').classList.remove('hidden');
                renderContent(docData.content);
            } else {
                try {
                    const response = await fetch(API_BASE + '/projects/' + serverName + '/' + projectName + '/docs/' + type, { credentials: 'same-origin' });
                    if (response.ok) {
                        const data = await response.json();
                        currentDocRawContent = data.content || '';
                        document.getElementById('docActions').classList.remove('hidden');
                        renderContent(data.content || 'No content available');
                    } else {
                        currentDocRawContent = '';
                        document.getElementById('docActions').classList.add('hidden');
                        const doc = PIPELINE_DOCS.find(d => d.type === type);
                        renderContent('## We couldn\'t display this document\n\nThe content for **' + type + '** isn\'t loading right now.\n\n' +
                            '**Try:** Run `' + (doc ? doc.cmd : '/pdev') + ' ' + projectName + '` to regenerate this document, or try refreshing the page.');
                    }
                } catch (err) {
                    currentDocRawContent = '';
                    document.getElementById('docActions').classList.add('hidden');
                    renderContent('## Connection Issue\n\nWe\'re having trouble connecting to the server.\n\n**Try:** Check your internet connection and refresh the page.');
                }
            }
        }
        
        // Constants for health score thresholds
        const HEALTH_THRESHOLDS = { GOOD: 80, WARNING: 60 };
        const GAP_COLORS = {
            critical: 'gap-critical',
            high: 'gap-high',
            medium: 'gap-medium',
            low: 'gap-low'
        };

        // Note: escapeHtml() defined above at line 365

        function parseFrontmatter(markdown) {
            if (!markdown || typeof markdown !== 'string') {
                return { meta: null, content: markdown || '' };
            }

            // Handle Windows line endings
            var normalizedMarkdown = markdown.replace(/\r\n/g, '\n');
            var match = normalizedMarkdown.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            if (!match) return { meta: null, content: markdown };

            var yamlLines = match[1].split('\n');
            var meta = {};
            var currentKey = null;

            yamlLines.forEach(function(line) {
                var colonIdx = line.indexOf(':');
                if (colonIdx > 0 && !line.trim().startsWith('-')) {
                    var key = line.slice(0, colonIdx).trim();
                    var value = line.slice(colonIdx + 1).trim();

                    // Handle quoted strings
                    if ((value.startsWith('"') && value.endsWith('"')) ||
                        (value.startsWith("'") && value.endsWith("'"))) {
                        value = value.slice(1, -1);
                    }

                    currentKey = key;
                    if (value === '') {
                        meta[key] = [];
                    } else {
                        meta[key] = value;
                    }
                } else if (line.trim().startsWith('-') && currentKey && Array.isArray(meta[currentKey])) {
                    meta[currentKey].push(line.trim().slice(1).trim());
                }
            });

            return { meta: meta, content: match[2] };
        }

        function getHealthClass(score) {
            if (score >= HEALTH_THRESHOLDS.GOOD) return 'health-good';
            if (score >= HEALTH_THRESHOLDS.WARNING) return 'health-warning';
            return 'health-critical';
        }

        function renderMetaCard(meta) {
            if (!meta) return '';

            var healthScore = meta.health_score ? parseInt(meta.health_score, 10) : null;
            if (healthScore !== null && isNaN(healthScore)) healthScore = null;

            var html = '<aside class="meta-card" role="complementary" aria-label="Document metadata">';
            html += '<div class="meta-header"><span class="meta-title">Document Info</span>';
            if (meta.pdev_version) {
                html += '<span class="meta-version">v' + escapeHtml(meta.pdev_version) + '</span>';
            }
            html += '</div>';
            html += '<dl class="meta-grid">';

            // Pipeline stage
            if (meta.pipeline_stage) {
                html += '<div class="meta-item">';
                html += '<dt class="meta-label">Stage</dt>';
                html += '<dd class="meta-value stage">' + escapeHtml(meta.pipeline_stage).replace(/_/g, ' ') + '</dd>';
                html += '</div>';
            }

            // Health score with accessible indicator
            if (healthScore !== null) {
                var healthClass = getHealthClass(healthScore);
                var healthLabel = healthScore >= HEALTH_THRESHOLDS.GOOD ? 'Good' :
                                  healthScore >= HEALTH_THRESHOLDS.WARNING ? 'Warning' : 'Critical';
                html += '<div class="meta-item">';
                html += '<dt class="meta-label">Health</dt>';
                html += '<dd class="meta-value ' + healthClass + '" aria-label="Health score: ' + healthScore + ' percent, ' + healthLabel + '">';
                html += healthScore + '%</dd>';
                html += '</div>';
            }

            // Remediation status
            if (meta.remediation_status) {
                html += '<div class="meta-item">';
                html += '<dt class="meta-label">Remediation</dt>';
                html += '<dd class="meta-value">' + escapeHtml(meta.remediation_status) + '</dd>';
                html += '</div>';
            }

            // Gap counts
            var gapTypes = ['critical', 'high', 'medium', 'low'];
            var gapCounts = gapTypes.filter(function(t) {
                return meta['gaps_' + t];
            }).map(function(t) {
                return { type: t, count: meta['gaps_' + t] };
            });

            if (gapCounts.length > 0) {
                html += '<div class="meta-item meta-gaps">';
                html += '<dt class="meta-label">Gaps</dt>';
                html += '<dd class="gap-badges" role="list">';
                gapCounts.forEach(function(g) {
                    html += '<span class="gap-badge ' + GAP_COLORS[g.type] + '" role="listitem" aria-label="' +
                        escapeHtml(g.count) + ' ' + g.type + ' priority gaps">' +
                        escapeHtml(g.count) + ' ' + g.type + '</span>';
                });
                html += '</dd></div>';
            }

            // Dates
            if (meta.created || meta.modified) {
                html += '<div class="meta-item">';
                html += '<dt class="meta-label">Dates</dt>';
                html += '<dd class="meta-value">';
                if (meta.created) html += 'Created: ' + escapeHtml(meta.created);
                if (meta.created && meta.modified) html += ' | ';
                if (meta.modified) html += 'Modified: ' + escapeHtml(meta.modified);
                html += '</dd></div>';
            }

            // Dependencies (if present)
            if (meta.dependencies && Array.isArray(meta.dependencies) && meta.dependencies.length > 0) {
                html += '<div class="meta-item meta-deps">';
                html += '<dt class="meta-label">Dependencies</dt>';
                html += '<dd class="meta-value">' + meta.dependencies.map(function(d) { return escapeHtml(d); }).join(', ') + '</dd>';
                html += '</div>';
            }

            html += '</dl></aside>';
            return html;
        }

        function renderContent(markdown) {
            var parsed = parseFrontmatter(markdown);
            var metaHtml = renderMetaCard(parsed.meta);
            var contentHtml = DOMPurify.sanitize(marked.parse(parsed.content));
            document.getElementById('doc-content').innerHTML = metaHtml + contentHtml;
            document.querySelectorAll('#doc-content pre code').forEach(function(block) {
                hljs.highlightElement(block);
            });
        }
        
        async function loadProjectSessions() {
            try {
                const response = await fetch(API_BASE + '/projects/' + serverName + '/' + projectName + '/sessions', { credentials: 'same-origin' });
                if (!response.ok) {
                    document.getElementById('session-list').innerHTML = '<li>No sessions found</li>';
                    return;
                }
                const data = await response.json();
                const sessions = data.sessions || data || [];
                const list = document.getElementById('session-list');
                if (!sessions.length) {
                    list.innerHTML = '<li>No sessions yet</li>';
                    return;
                }
                list.innerHTML = sessions.slice(0, 10).map(function(s) {
                    var isResumable = s.session_status === 'active' || s.session_status === 'paused';
                    var resumeBtn = isResumable ?
                        '<button class="btn btn-sm btn-primary session-resume-btn" onclick="resumeSession(\'' + escapeHtml(s.id) + '\')">Resume</button>' :
                        '';
                    return '<li class="session-item">' +
                        '<div class="session-info">' +
                        '<a href="session.html?id=' + escapeHtml(s.id) + '">/' + escapeHtml(s.command_type || 'session') + '</a> ' +
                        '<span class="session-date">' + escapeHtml(new Date(s.created_at).toLocaleDateString()) + '</span> ' +
                        '<span class="session-steps">(' + escapeHtml(String(s.step_count || 0)) + ' steps)</span>' +
                        '</div>' +
                        '<div class="session-actions">' + resumeBtn + '</div>' +
                        '</li>';
                }).join('');
            } catch (err) {
                document.getElementById('session-list').innerHTML = '<li>Sessions unavailable - try refreshing</li>';
            }
        }
        
        init();

        // Resume Session Function
        async function resumeSession(sessionId) {
            try {
                var response = await fetch(API_BASE + '/sessions/' + sessionId + '/reopen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin'
                });
                if (!response.ok) {
                    throw new Error('Failed to resume session');
                }
                // Redirect to session view
                window.location.href = 'session.html?id=' + sessionId;
            } catch (err) {
                console.error('Resume error:', err);
                alert('Failed to resume session: ' + err.message);
            }
        }

        // Share Modal Functions
        function openShareModal() {
            // Block guest users from opening share modal
            if (isGuestView) {
                console.warn('[PDev] Share functionality disabled for guest viewers');
                return;
            }
            document.getElementById('shareModal').classList.remove('hidden');
            document.getElementById('shareResult').classList.add('hidden');
            document.getElementById('shareEmail').value = '';
            document.getElementById('createShareBtn').disabled = false;
            document.getElementById('createShareBtn').textContent = 'Create Link';
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
        }

        async function createShareLink() {
            // Block guest users from creating share links
            if (isGuestView) {
                console.warn('[PDev] Share functionality disabled for guest viewers');
                return;
            }
            var email = document.getElementById('shareEmail').value.trim();
            var hours = document.getElementById('shareExpiry').value;
            var btn = document.getElementById('createShareBtn');

            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                // Request share token from server (origin-validated)
                var tokenRes = await fetch(API_BASE + '/share-token', { method: 'POST', credentials: 'same-origin' });
                if (!tokenRes.ok) throw new Error('Not authorized to create share links');
                var tokenData = await tokenRes.json();

                var res = await fetch(API_BASE + '/project-share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Share-Token': tokenData.token }, credentials: 'same-origin',
                    body: JSON.stringify({
                        server: serverName,
                        project: projectName,
                        email: email || null,
                        expiresInHours: parseInt(hours)
                    })
                });

                if (!res.ok) throw new Error('Failed to create share link');
                var data = await res.json();

                document.getElementById('shareLink').value = data.shareUrl;
                document.getElementById('shareExpires').textContent = 'Expires: ' + new Date(data.expiresAt).toLocaleString();
                document.getElementById('shareResult').classList.remove('hidden');
                btn.textContent = 'Link Created';
            } catch (err) {
                alert('Failed to create share link: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'Create Link';
            }
        }

        function copyShareLink() {
            var input = document.getElementById('shareLink');
            input.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        }

        // Copy/Download Document Functions
        function copyDocContent() {
            if (!currentDocRawContent) {
                return;
            }

            var btn = document.getElementById('copyBtn');
            var origText = btn.textContent;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentDocRawContent).then(function() {
                    btn.textContent = '‚úì';
                    btn.setAttribute('aria-label', 'Copied to clipboard');
                    setTimeout(function() {
                        btn.textContent = origText;
                        btn.setAttribute('aria-label', 'Copy raw markdown to clipboard');
                    }, 2000);
                }).catch(function(err) {
                    console.error('Clipboard API failed:', err);
                    fallbackCopyDoc();
                });
            } else {
                fallbackCopyDoc();
            }
        }

        function fallbackCopyDoc() {
            var textarea = document.createElement('textarea');
            textarea.value = currentDocRawContent;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                var btn = document.getElementById('copyBtn');
                var origText = btn.textContent;
                btn.textContent = '‚úì';
                setTimeout(function() { btn.textContent = origText; }, 2000);
            } catch (err) {
                console.error('Fallback copy failed:', err);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function downloadDocContent() {
            if (!currentDocRawContent) {
                return;
            }

            var docInfo = PIPELINE_DOCS.find(function(d) { return d.type === currentDocType; });
            var filename = docInfo ? docInfo.name : (currentDocType + '.md');

            var blob = new Blob([currentDocRawContent], { type: 'text/markdown;charset=utf-8' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportToPDF() {
            if (!currentDocRawContent) {
                return;
            }

            var docInfo = PIPELINE_DOCS.find(function(d) { return d.type === currentDocType; });
            var docName = docInfo ? docInfo.name.replace('.md', '') : currentDocType;
            var docContent = document.getElementById('doc-content').innerHTML;

            // Open print-friendly window
            var printWindow = window.open('', '_blank');
            printWindow.document.write('\
<!DOCTYPE html>\
<html>\
<head>\
    <meta charset="UTF-8">\
    <title>' + escapeHtml(docName) + ' - PDev Suite</title>\
    <style>\
        @media print {\
            @page { margin: 1in; size: letter; }\
        }\
        body {\
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\
            line-height: 1.6;\
            color: #1a1a1a;\
            max-width: 8.5in;\
            margin: 0 auto;\
            padding: 0.5in;\
            background: white;\
        }\
        h1 { font-size: 1.8rem; border-bottom: 2px solid #6366f1; padding-bottom: 0.5rem; margin-top: 0; }\
        h2 { font-size: 1.4rem; color: #333; margin-top: 1.5rem; border-bottom: 1px solid #ddd; padding-bottom: 0.3rem; }\
        h3 { font-size: 1.2rem; color: #444; margin-top: 1.2rem; }\
        h4 { font-size: 1rem; color: #555; margin-top: 1rem; }\
        p { margin: 0.8rem 0; }\
        ul, ol { margin: 0.8rem 0; padding-left: 1.5rem; }\
        li { margin: 0.3rem 0; }\
        code { background: #f4f4f5; padding: 0.15rem 0.3rem; border-radius: 3px; font-size: 0.9em; }\
        pre { background: #f4f4f5; padding: 1rem; border-radius: 6px; overflow-x: auto; font-size: 0.85rem; }\
        pre code { background: none; padding: 0; }\
        table { border-collapse: collapse; width: 100%; margin: 1rem 0; }\
        th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }\
        th { background: #f4f4f5; font-weight: 600; }\
        blockquote { border-left: 3px solid #6366f1; margin: 1rem 0; padding-left: 1rem; color: #555; }\
        hr { border: none; border-top: 1px solid #ddd; margin: 1.5rem 0; }\
        .header { text-align: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #ddd; }\
        .header h1 { border: none; margin-bottom: 0.5rem; }\
        .header .meta { color: #666; font-size: 0.9rem; }\
        .footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ddd; text-align: center; color: #888; font-size: 0.8rem; }\
    </style>\
</head>\
<body>\
    <div class="header">\
        <h1>' + escapeHtml(docName) + '</h1>\
        <div class="meta">Generated by PDev Suite ‚Ä¢ ' + new Date().toLocaleDateString() + '</div>\
    </div>\
    ' + docContent + '\
    <div class="footer">PDev Suite Document</div>\
</body>\
</html>');
            printWindow.document.close();

            // Wait for content to load then trigger print
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
            };
        }
    </script>

    <!-- Share Modal -->
    <div id="shareModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share Project</h3>
                <button class="modal-close" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="shareEmail">Client Email (optional)</label>
                    <input type="email" id="shareEmail" placeholder="client@example.com">
                </div>
                <div class="form-group">
                    <label for="shareExpiry">Link expires in</label>
                    <select id="shareExpiry">
                        <option value="24">24 hours</option>
                        <option value="48">48 hours</option>
                        <option value="72" selected>72 hours (3 days)</option>
                        <option value="168">1 week</option>
                        <option value="336">2 weeks</option>
                        <option value="720">30 days</option>
                    </select>
                </div>
                <div id="shareResult" class="share-result hidden">
                    <label>Share Link</label>
                    <div class="share-link-row">
                        <input type="text" id="shareLink" readonly>
                        <button class="btn" onclick="copyShareLink()">Copy</button>
                    </div>
                    <p id="shareExpires" class="share-expires"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeShareModal()">Cancel</button>
                <button class="btn btn-primary" id="createShareBtn" onclick="createShareLink()">Create Link</button>
            </div>
        </div>
    </div>
<script src="version-check.js"></script>
</body>
</html>
