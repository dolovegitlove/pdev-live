<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - PDev Live</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="pdev-live.css">
    <link rel="stylesheet" href="settings-specific.css">
</head>
<body>
    <!-- Navigation Header -->
    <nav class="nav-header">
        <a href="/pdev/" class="nav-logo">
            <div class="nav-logo-icon">P</div>
            <span>PDev Suite</span>
        </a>
        <div class="nav-links">
            <a href="/pdev/live/" class="nav-link">Live</a>
            <a href="/pdev/live/projects.html" class="nav-link">Projects</a>
            <a href="/pdev/live/docs.html" class="nav-link">Docs</a>
            <a href="/pdev/live/settings.html" class="nav-link active">Settings</a>
        </div>
    </nav>

    <div class="container">
        <header>
            <div class="logo">Settings</div>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Loading...</span>
            </div>
        </header>

        <div class="settings-container">
            <!-- Success/Error Messages -->
            <div id="messageContainer" class="message-container"></div>

            <!-- Tabs -->
            <div class="settings-tabs" role="tablist" aria-label="Settings sections">
                <button type="button" class="tab-btn active" role="tab" aria-selected="true" aria-controls="tab-account" id="btn-account" onclick="switchTab('account')">Account</button>
                <button type="button" class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-git" id="btn-git" onclick="switchTab('git')">Git Sync</button>
                <button type="button" class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-servers" id="btn-servers" onclick="switchTab('servers')">Servers</button>
                <button type="button" class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-about" id="btn-about" onclick="switchTab('about')">About</button>
            </div>

            <!-- Account Tab -->
            <div id="tab-account" class="tab-content active" role="tabpanel" aria-labelledby="btn-account">
                <section class="settings-section">
                    <div class="section-header">
                        <h2>Account Security</h2>
                        <p class="section-description">Update your username or password. Your current password confirms your identity.</p>
                    </div>

                    <div class="info-box info">
                        <div class="info-icon">üîí</div>
                        <div class="info-content">
                            <h3>Secure Account Changes</h3>
                            <p>Your current password confirms your identity. After updating, you'll need to sign in again with your new credentials.</p>
                            <p><strong>Your data is safe:</strong> All projects, sessions, and settings remain unchanged.</p>
                        </div>
                    </div>

                    <form id="credentialForm" onsubmit="updateCredentials(event)">
                        <div class="setting-item">
                            <label for="currentPassword" class="input-label">
                                <span class="label-title">Current Password</span>
                                <span class="label-help">Required to verify it's really you</span>
                            </label>
                            <input
                                type="password"
                                id="currentPassword"
                                class="input-text"
                                placeholder="Enter your current password"
                                required
                                autocomplete="current-password"
                                aria-required="true"
                            >
                        </div>

                        <div class="setting-item">
                            <label for="newUsername" class="input-label">
                                <span class="label-title">New Username (optional)</span>
                                <span class="label-help">3-50 characters. Letters, numbers, and underscores only.</span>
                            </label>
                            <input
                                type="text"
                                id="newUsername"
                                class="input-text"
                                placeholder="Leave blank to keep current"
                                autocomplete="username"
                                pattern="^[a-zA-Z0-9_]{3,50}$"
                                minlength="3"
                                maxlength="50"
                            >
                        </div>

                        <div class="setting-item">
                            <label for="newPassword" class="input-label">
                                <span class="label-title">New Password (optional)</span>
                                <span class="label-help">At least 12 characters for security.</span>
                            </label>
                            <input
                                type="password"
                                id="newPassword"
                                class="input-text"
                                placeholder="Leave blank to keep current"
                                autocomplete="new-password"
                                minlength="12"
                                maxlength="200"
                                oninput="checkPasswordStrength()"
                            >
                            <div id="passwordStrength" class="password-strength hidden" role="status" aria-live="polite">
                                <span class="strength-bar"><span id="strengthFill" class="strength-fill"></span></span>
                                <span id="strengthLabel" class="strength-label"></span>
                            </div>
                        </div>

                        <div class="setting-item confirm-password-group hidden" id="confirmPasswordGroup">
                            <label for="confirmPassword" class="input-label">
                                <span class="label-title">Confirm New Password</span>
                                <span class="label-help">Re-enter your new password to confirm</span>
                            </label>
                            <input
                                type="password"
                                id="confirmPassword"
                                class="input-text"
                                placeholder="Re-enter your new password"
                                autocomplete="new-password"
                            >
                            <small id="confirmError" class="input-error hidden"></small>
                        </div>

                        <div class="save-section">
                            <button id="saveCredentialsButton" class="btn-save" type="submit">Update Account &amp; Sign Out</button>
                            <p class="save-help">After saving, you'll be signed out and redirected to sign in with your new credentials.</p>
                        </div>
                    </form>
                </section>
            </div>

            <!-- Git Sync Tab -->
            <div id="tab-git" class="tab-content hidden" role="tabpanel" aria-labelledby="btn-git">
                <section class="settings-section">
                    <div class="section-header">
                        <h2>Git Auto-Commit</h2>
                        <p class="section-description">Automatically commit and push PDev pipeline documents to your git repositories</p>
                    </div>

                    <div class="settings-grid">
                        <!-- Enable Toggle -->
                        <div class="setting-item">
                            <div class="toggle-label">
                                <div class="toggle-info">
                                    <span class="toggle-title" id="autoGitLabel">Enable automatic git commits</span>
                                    <span class="toggle-help">When enabled, PDev docs (IDEATION.md, PRODUCT_SPEC.md, etc.) will be automatically committed and pushed to git</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="pdevAutoGit" aria-labelledby="autoGitLabel">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Repository Whitelist -->
                        <div class="setting-item">
                            <label for="pdevGitRepos" class="input-label">
                                <span class="label-title">Whitelisted Repositories</span>
                                <span class="label-help">Only PDev docs in these repositories will be auto-committed. Enter one absolute path per line.</span>
                            </label>
                            <textarea
                                id="pdevGitRepos"
                                class="input-textarea"
                                placeholder="/Users/username/projects/myapp&#10;/Users/username/projects/client-site"
                                rows="4"
                                aria-describedby="reposHelp"
                            ></textarea>
                            <small id="reposHelp" class="input-help">Example: /Users/dolovdev/projects/myapp</small>
                        </div>

                        <!-- Git Remote -->
                        <div class="setting-item">
                            <label for="pdevGitRemote" class="input-label">
                                <span class="label-title">Git Remote</span>
                                <span class="label-help">Remote repository to push to after auto-commit</span>
                            </label>
                            <select id="pdevGitRemote" class="input-select" aria-describedby="remoteHelp">
                                <option value="origin">origin (default)</option>
                                <option value="upstream">upstream</option>
                            </select>
                            <small id="remoteHelp" class="input-help">Most repositories use 'origin' as the default remote</small>
                        </div>
                    </div>
                </section>

                <!-- Safety Information -->
                <section class="settings-section">
                    <div class="section-header">
                        <h2>Safety & Security</h2>
                    </div>

                    <div class="info-boxes">
                        <div class="info-box info">
                            <div class="info-icon">‚ÑπÔ∏è</div>
                            <div class="info-content">
                                <h3>What gets auto-committed</h3>
                                <p>Only PDev pipeline documents are auto-committed:</p>
                                <ul>
                                    <li>IDEATION.md, PRODUCT_SPEC.md, DEVELOPMENT_SOP.md</li>
                                    <li>BENCHMARK.md, DESIGN_SYSTEM.md, CAPABILITIES.md</li>
                                </ul>
                                <p><strong>Not committed:</strong> Source code, configuration files, or other documentation.</p>
                            </div>
                        </div>

                        <div class="info-box warning">
                            <div class="info-icon">‚ö†Ô∏è</div>
                            <div class="info-content">
                                <h3>Automatic safety checks</h3>
                                <p>Auto-commits are skipped during git merges, rebases, in detached HEAD state, when content hasn't changed, or in repositories not on the whitelist.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Save Button -->
                <div class="save-section">
                    <button id="saveGitButton" class="btn-save" type="button" onclick="saveGitSettings()">Save Git Settings</button>
                    <p class="save-help">Changes will take effect on next PDev document generation</p>
                </div>
            </div>

            <!-- Servers Tab -->
            <div id="tab-servers" class="tab-content hidden" role="tabpanel" aria-labelledby="btn-servers">
                <section class="settings-section">
                    <div class="section-header">
                        <h2>Connected Servers</h2>
                        <p class="section-description">Servers configured to send pipeline data to PDev Live</p>
                    </div>

                    <div id="serversList" class="servers-list">
                        <div class="loading-text">Loading servers...</div>
                    </div>
                </section>

                <section class="settings-section">
                    <div class="info-box">
                        <div class="info-icon">üìö</div>
                        <div class="info-content">
                            <h3>Adding New Servers</h3>
                            <p>To add a new server, update the <code>VALID_SERVERS</code> array in the server configuration and redeploy.</p>
                            <p class="muted">Server list is managed in: <code>server/server.js</code></p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- About Tab -->
            <div id="tab-about" class="tab-content hidden" role="tabpanel" aria-labelledby="btn-about">
                <section class="settings-section">
                    <div class="section-header">
                        <h2>PDev Live</h2>
                    </div>

                    <div class="about-grid">
                        <div class="about-item">
                            <span class="about-label">Version</span>
                            <span class="about-value" id="appVersion">-</span>
                        </div>
                        <div class="about-item">
                            <span class="about-label">Environment</span>
                            <span class="about-value" id="appEnv">-</span>
                        </div>
                        <div class="about-item">
                            <span class="about-label">Database</span>
                            <span class="about-value" id="dbStatus">-</span>
                        </div>
                        <div class="about-item">
                            <span class="about-label">Uptime</span>
                            <span class="about-value" id="appUptime">-</span>
                        </div>
                        <div class="about-item">
                            <span class="about-label">Active Sessions</span>
                            <span class="about-value" id="activeSessions">-</span>
                        </div>
                        <div class="about-item">
                            <span class="about-label">Connected Clients</span>
                            <span class="about-value" id="connectedClients">-</span>
                        </div>
                    </div>
                </section>

                <section class="settings-section">
                    <div class="section-header">
                        <h2>Documentation & Logs</h2>
                    </div>

                    <div class="info-boxes">
                        <div class="info-box">
                            <div class="info-icon">üìñ</div>
                            <div class="info-content">
                                <h3>PDev Pipeline Reference</h3>
                                <p>Full documentation for PDev commands and pipeline stages.</p>
                                <code>~/.claude/PDEV_PIPELINE.md</code>
                            </div>
                        </div>

                        <div class="info-box">
                            <div class="info-icon">üìù</div>
                            <div class="info-content">
                                <h3>Activity Logs</h3>
                                <p>View PDev Live activity and git sync logs:</p>
                                <code>~/.claude/logs/pdev-live.log</code>
                                <p class="muted"><code>~/.claude/logs/pdev-git-sync.log</code></p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/pdev';

        // Security: HTML escape helper
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Tab switching
        function switchTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            document.getElementById('btn-' + tabId).classList.add('active');
            document.getElementById('btn-' + tabId).setAttribute('aria-selected', 'true');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById('tab-' + tabId).classList.remove('hidden');

            // Load tab-specific data
            if (tabId === 'servers') loadServers();
            if (tabId === 'about') loadAbout();
        }

        // Show message
        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `
                <div class="message message-${escapeHtml(type)}">
                    <span class="message-icon">${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
                    <span class="message-text">${escapeHtml(text)}</span>
                    <button class="message-close" onclick="this.parentElement.remove()" aria-label="Close message">√ó</button>
                </div>
            `;

            if (type === 'success') {
                setTimeout(() => {
                    const message = container.querySelector('.message');
                    if (message) message.remove();
                }, 5000);
            }
        }

        // Account/Credential Management
        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthContainer = document.getElementById('passwordStrength');
            const strengthFill = document.getElementById('strengthFill');
            const strengthLabel = document.getElementById('strengthLabel');
            const confirmGroup = document.getElementById('confirmPasswordGroup');

            if (password.length === 0) {
                strengthContainer.classList.add('hidden');
                confirmGroup.classList.add('hidden');
                return;
            }

            strengthContainer.classList.remove('hidden');
            confirmGroup.classList.remove('hidden');

            let strength = 'weak';
            let score = 0;

            if (password.length >= 12) score++;
            if (password.length >= 16) score++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^a-zA-Z0-9]/.test(password)) score++;

            if (score >= 4) strength = 'strong';
            else if (score >= 3) strength = 'good';
            else if (score >= 2) strength = 'fair';

            strengthFill.setAttribute('data-strength', strength);
            strengthLabel.setAttribute('data-strength', strength);
            strengthLabel.textContent = strength.charAt(0).toUpperCase() + strength.slice(1);
        }

        async function updateCredentials(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newUsername = document.getElementById('newUsername').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const confirmError = document.getElementById('confirmError');
            const btn = document.getElementById('saveCredentialsButton');

            // Clear previous errors
            confirmError.classList.add('hidden');
            confirmError.textContent = '';

            // Validate at least one new value
            if (!newUsername && !newPassword) {
                showMessage('Please provide a new username or password', 'error');
                return;
            }

            // Validate password confirmation
            if (newPassword && newPassword !== confirmPassword) {
                confirmError.textContent = 'The passwords you entered don\'t match. Please check both fields.';
                confirmError.classList.remove('hidden');
                document.getElementById('confirmPassword').focus();
                return;
            }

            // Validate username format if provided
            if (newUsername && !/^[a-zA-Z0-9_]{3,50}$/.test(newUsername)) {
                showMessage('Username must be 3-50 characters (letters, numbers, underscore only)', 'error');
                return;
            }

            // Validate password length if provided
            if (newPassword && newPassword.length < 12) {
                showMessage('Password must be at least 12 characters for security', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Updating...';

            try {
                const response = await fetch(`${API_BASE}/auth/update-credentials`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPassword,
                        newUsername: newUsername || undefined,
                        newPassword: newPassword || undefined
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (data.code === 'REAUTH_REQUIRED') {
                        showMessage('For security, please log out and log back in before changing credentials', 'error');
                    } else {
                        showMessage(data.error || 'Failed to update credentials', 'error');
                    }
                    return;
                }

                showMessage('Credentials updated successfully! Redirecting to login...', 'success');
                setTimeout(() => {
                    window.location.href = '/pdev/live/login.html';
                }, 2000);

            } catch (error) {
                showMessage('Connection error. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Update Account & Sign Out';
            }
        }

        // Git Settings
        let gitSettings = {
            pdevAutoGit: false,
            pdevGitRepos: [],
            pdevGitRemote: 'origin'
        };

        async function loadGitSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`);
                if (!response.ok) throw new Error('Failed to load settings');

                gitSettings = await response.json();
                document.getElementById('pdevAutoGit').checked = gitSettings.pdevAutoGit;
                document.getElementById('pdevGitRepos').value = gitSettings.pdevGitRepos.join('\n');
                document.getElementById('pdevGitRemote').value = gitSettings.pdevGitRemote;
            } catch (error) {
                console.error('Failed to load git settings:', error);
            }
        }

        async function saveGitSettings() {
            const btn = document.getElementById('saveGitButton');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const pdevAutoGit = document.getElementById('pdevAutoGit').checked;
                const pdevGitReposText = document.getElementById('pdevGitRepos').value.trim();
                const pdevGitRepos = pdevGitReposText ? pdevGitReposText.split('\n').map(line => line.trim()).filter(Boolean) : [];
                const pdevGitRemote = document.getElementById('pdevGitRemote').value;

                if (pdevAutoGit && pdevGitRepos.length === 0) {
                    throw new Error('Please add at least one repository path when enabling auto-commit');
                }

                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pdevAutoGit, pdevGitRepos, pdevGitRemote })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save settings');
                }

                showMessage('Git settings saved successfully', 'success');
            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Git Settings';
            }
        }

        // Servers
        async function loadServers() {
            const container = document.getElementById('serversList');
            try {
                const response = await fetch(`${API_BASE}/servers`);
                if (!response.ok) throw new Error('Failed to load servers');

                const data = await response.json();
                const servers = data.servers || [];

                if (servers.length === 0) {
                    container.innerHTML = '<div class="empty-text">No servers configured</div>';
                    return;
                }

                container.innerHTML = servers.map(server => `
                    <div class="server-item">
                        <span class="server-name">${escapeHtml(server)}</span>
                        <span class="server-status status-active">Configured</span>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = '<div class="error-text">We couldn\'t load servers right now. Try refreshing the page.</div>';
            }
        }

        // About
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);

            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m`;
        }

        async function loadAbout() {
            try {
                const [versionRes, healthRes] = await Promise.all([
                    fetch(`${API_BASE}/version`),
                    fetch(`${API_BASE}/health`)
                ]);

                if (versionRes.ok) {
                    const version = await versionRes.json();
                    document.getElementById('appVersion').textContent = version.version || '-';
                }

                if (healthRes.ok) {
                    const health = await healthRes.json();
                    document.getElementById('appEnv').textContent = health.environment || '-';
                    document.getElementById('dbStatus').textContent = health.database || '-';
                    document.getElementById('appUptime').textContent = formatUptime(health.uptime || 0);
                    document.getElementById('activeSessions').textContent = health.activeSessions || '0';
                    document.getElementById('connectedClients').textContent = health.globalClients || '0';

                    // Update status dot
                    const statusDot = document.getElementById('statusDot');
                    const statusText = document.getElementById('statusText');
                    if (health.database === 'connected') {
                        statusDot.className = 'status-dot connected';
                        statusText.textContent = 'Connected';
                    } else {
                        statusDot.className = 'status-dot';
                        statusText.textContent = 'Disconnected';
                    }
                }
            } catch (error) {
                console.error('Failed to load about info:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadGitSettings();
            loadAbout(); // Load status on page load
        });
    </script>
</body>
</html>
