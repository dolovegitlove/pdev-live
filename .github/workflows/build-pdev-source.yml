name: Build PDev Source Tarball

on:
  push:
    branches: [main]
    paths:
      - 'installer/**'
      - 'server/**'
      - 'frontend/**'
      - 'client/**'
      - '.github/workflows/build-pdev-source.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.5)'
        required: false

jobs:
  build-tarball:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Auto-increment minor version from latest tag
            LATEST=$(git describe --tags --abbrev=0 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+$' || echo "1.0.3")
            MAJOR=$(echo $LATEST | cut -d. -f1)
            MINOR=$(echo $LATEST | cut -d. -f2)
            PATCH=$(echo $LATEST | cut -d. -f3)
            PATCH=$((PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build pdev-source tarball
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TARBALL="pdev-source-v${VERSION}.tar.gz"

          echo "Creating ${TARBALL}..."
          tar -czf "${TARBALL}" \
            --dereference \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='*.log' \
            --exclude='*.tmp' \
            --exclude='.DS_Store' \
            --exclude='installer/dist' \
            --exclude='installer/bundle/node_modules' \
            --exclude='desktop' \
            server/ installer/ frontend/ client/

          if [ ! -f "${TARBALL}" ]; then
            echo "‚ùå Failed to create tarball"
            exit 1
          fi

          SIZE=$(ls -lh "${TARBALL}" | awk '{print $5}')
          echo "‚úÖ Created ${TARBALL} (${SIZE})"

          # Generate SHA256 checksum
          sha256sum "${TARBALL}" > "${TARBALL}.sha256"
          echo "‚úÖ Generated SHA256 checksum"

          echo "tarball=${TARBALL}" >> $GITHUB_OUTPUT

      - name: Verify tarball contents
        run: |
          TARBALL=${{ steps.build-tarball.outputs.tarball }}

          echo "Verifying required files in tarball..."

          REQUIRED_FILES=(
            "installer/installer-server.js"
            "installer/package.installer.json"
            "installer/ecosystem.installer.config.js"
            "installer/pdl-installer.sh"
            "installer/migrations/"
            "server/"
            "frontend/"
            "client/"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if tar -tzf "${TARBALL}" | grep -q "^${file}"; then
              echo "‚úÖ Found: ${file}"
            else
              echo "‚ùå Missing: ${file}"
              exit 1
            fi
          done

          echo "‚úÖ All required files verified in tarball"

      - name: Upload tarball as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdev-source-tarball
          path: |
            pdev-source-v*.tar.gz
            pdev-source-v*.tar.gz.sha256
          retention-days: 30

      - name: Deploy to acme server
        if: success()
        env:
          DEPLOY_KEY: ${{ secrets.VYXENAI_DEPLOY_KEY }}
          DEPLOY_HOST: acme
          DEPLOY_PATH: /var/www/vyxenai.com/pdev/install
        run: |
          TARBALL=${{ steps.build-tarball.outputs.tarball }}

          # Create SSH key file
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Add host key
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          # Deploy files
          echo "Deploying ${TARBALL} to acme..."
          scp -i ~/.ssh/deploy_key "${TARBALL}" "${TARBALL}.sha256" "acme:${DEPLOY_PATH}/"

          # Fix permissions
          ssh -i ~/.ssh/deploy_key "acme" \
            "cd ${DEPLOY_PATH} && \
             sudo chown www-data:www-data ${TARBALL}* && \
             sudo chmod 644 ${TARBALL}* && \
             ls -lh ${TARBALL}* && \
             echo '‚úÖ Deployed successfully'"

          # Cleanup
          rm -f ~/.ssh/deploy_key

      - name: Update installer version
        if: success()
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TARBALL=${{ steps.build-tarball.outputs.tarball }}

          # Update TARBALL_VERSION in pdl-installer.sh
          sed -i "s/TARBALL_VERSION=\"[0-9.]*\"/TARBALL_VERSION=\"${VERSION}\"/" installer/pdl-installer.sh

          # Check if changes were made
          if git diff --quiet installer/pdl-installer.sh; then
            echo "No version changes needed"
          else
            echo "‚úÖ Updated TARBALL_VERSION to ${VERSION}"
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add installer/pdl-installer.sh
            git commit -m "chore: Update TARBALL_VERSION to ${VERSION} for new source tarball"

            # Push changes
            git push
          fi

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          files: |
            pdev-source-v*.tar.gz
            pdev-source-v*.tar.gz.sha256
          tag_name: pdev-source-v${{ steps.version.outputs.version }}
          body: |
            # PDev Source Tarball v${{ steps.version.outputs.version }}

            Self-contained installer tarball for PDev Live.

            ## Contents
            - ‚úÖ installer-server.js - Web installation wizard backend
            - ‚úÖ package.installer.json - NPM dependencies
            - ‚úÖ ecosystem.installer.config.js - PM2 configuration
            - ‚úÖ pdl-installer.sh - Main installation script
            - ‚úÖ Migrations, templates, and configuration files

            ## Verification
            ```bash
            sha256sum -c pdev-source-v${{ steps.version.outputs.version }}.tar.gz.sha256
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify deployment success
        if: success()
        run: |
          echo "‚úÖ PDev Source Tarball v${{ steps.version.outputs.version }} Built & Deployed"
          echo "üì¶ Tarball: ${{ steps.build-tarball.outputs.tarball }}"
          echo "üöÄ Deployed to: acme:/var/www/vyxenai.com/pdev/install/"
          echo "üìù Version updated in: installer/pdl-installer.sh"
